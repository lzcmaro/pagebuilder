Device=Backbone.View.extend({_builder:null,_currentPage:"",_currentPageObj:null,_highlighter:null,_highlightedEl:null,_highlightSelector:null,_dirtyPages:{},initialize:function(e){console.log("DEVICE: initializing");var e=this;setTimeout(function d(){var a=parent.BuilderDeviceGlue.getBuilderFromDevice();if(a){e._builder=a,e.initEvents(),a.onDeviceReady()}else{setTimeout(d,50)}},50)},initEvents:function(){var b=this;$("body").delegate(".cfwx-control, .highlight, .highlight-selector","mousemove",function(a){return $(this).hasClass("highlight-selector")&&b.repositionCurrentSelector(),b.moveHover(a),!$(this).hasClass("highlight")}).delegate(".cfwx-control, .highlight, .highlight-selector","click",function(a){if($(this).hasClass("cfwx-control")){return b._controlClicked($(this).data("cid")),!1}else{if(!b._currentPageObj){return !1}var h=$(".cfwx-control",b._currentPageObj);for(var g=h.length-1;g>=0;g--){var f=h.eq(g);if(b._controlElementContains(f,a.pageX,a.pageY)&&b._isValidHoverTarget(f)){return b._controlClicked($(f).data("cid")),!1}}return !1}}).delegate(".highlight, .highlight-selector","mousedown",function(a){if(!b._currentPageObj){return}var h=$(".cfwx-control",b._currentPageObj);for(var g=h.length-1;g>=0;g--){var f=h.eq(g);b._controlElementContains(f,a.pageX,a.pageY)&&b._isValidHoverTarget(f)&&((a.target=f.get(0)),f.trigger(a))}}).delegate(".cfwx-control","mouseenter",function(){return b._isValidHoverTarget($(this))&&b.startHover($(this)),!1}).delegate(".highlight","mouseleave",function(){return b._isValidHoverTarget($(this))&&b.startHover($(this)),!1});$("a:not([href^=#])").live("click",function(){return !1});$(window).scroll(function(){$(document).scrollTop()==0&&b.stopScrolling(),$(document).scrollTop()+$(window).height()>=$(document).height()&&b.stopScrolling(),b.repositionCurrentSelector()})},removeEvents:function(){this.unbind(),$("body").undelegate()},removeSorting:function(){$(".ui-sortable").each(function(){$(this).sortable("disable")})},enableSorting:function(){$('[data-role="content"]').each(function(){$(this).sortable("enable")})},_controlClicked:function(b){if(!b){return}console.log("DEVICE: clicked on element ",b),this._highlighterHidden=!1,this.trigger("controlSelected",b)},startDragDrop:function(b){this._dragDropping=!0},stopDragDrop:function(){this._dragDropping=!1},onAllControlsDeselected:function(){this._highlightSelector&&($(this._highlightSelector).remove(),this._highlightSelector=null),this.endHover()},onControlSelected:function(e){var d=$(e.getDeviceRenderedEl());this.selectAndHighlightElement(d)},onPageChanged:function(){var e=$.mobile.activePage,d=$(e).data("cid");this._builder&&this._builder.isPreviewMode()&&this.markPageDirty(d),this.trigger("pageChanged",d)},markPageDirty:function(b){if(!b){return}this._dirtyPages[b]=!0},_controlElementContains:function(j,i,p){var o=this._builder.getControl($(j).data("cid"));if(!o){return !1}var n=j.offset(),m=j.outerWidth(),l=j.outerHeight(),k=o.getCalculatedMargin();if(k[3]<0&&k[1]<0){if(i>n.left+m+-k[1]||i<n.left+k[3]||p>n.top+l||p<n.top){return !1}}else{if(i>n.left+m||i<n.left||p>n.top+l||p<n.top){return !1}}return !0},selectAndHighlightElement:function(b){this._repositionSelector(b)},repositionCurrentSelector:function(){if(!this._builder){return}if(this._builder.isPreviewMode()){return}if(this._builder.getSelectedControl()){var b=this._builder.getSelectedControl().getDeviceRenderedEl();if(!b){this._builder.setSelectedControl(null);return}this._repositionSelector(b)}this._highlightedEl&&this._repositionHover(this._highlightedEl)},_makeHighlightSelector:function(e){if(e){var d=this,f=$('<div class="highlight-selector"><div class="content"><div class="buttons"><a href="javascript:void(0);" title="复制" class="c-icon c-icon-plus"></a> <a href="javascript:void(0);" title="删除" class="c-icon c-icon-close"></a></div></div></div>');return $(".c-icon-plus",f).click(function(){var b=d._builder.getSelectedControl();if(b){var g=d._builder.duplicateControl(b);d._builder.onControlSelected(g)}return !1}),$(".c-icon-close",f).click(function(){var b=d._builder.getSelectedControl();return b&&d._builder.removeControl(b),!1}),f}return $('<div class="highlight-selector noborder"><div class="content"></div></div>')},_repositionSelector:function(h){if(!this._builder){return}var g=this._builder.getControl($(h).data("cid"));if(!g){this._builder.setSelectedControl(null);return}var l=h.offset();this._highlightSelector||(this._highlightSelector=this._makeHighlightSelector(g.getControlType()!="page"),$(this._highlightSelector).appendTo("body"),h.attr("data-position")=="fixed"&&(this._highlightSelector.find(".buttons").css("bottom","4px"),this._highlightSelector.find(".c-icon-plus").remove()));var k=g.getCalculatedMargin(),j=$(window).height();if(k[3]<0&&k[1]<0){var i=k[3]+k[1];$(this._highlightSelector).css({left:l.left+k[1],top:l.top,width:h.outerWidth()-i,height:h.outerHeight()})}else{$(this._highlightSelector).css({left:l.left,top:l.top,width:h.width(),height:h.outerHeight()})}},startHover:function(b){if(this._isSorting===!0){return}this._highlighter||(this._highlighter=$('<div id="highlight" class="highlight"></div>').appendTo("body")),this._highlighter.hide(),this._repositionHover(b),this._highlightedEl=b},endHover:function(){if(!this._highlighter){return}this._highlighter.hide(),this._highlighterHidden=!1},startSorting:function(){this._isSorting=!0},endSorting:function(){this._isSorting=!1,this.repositionCurrentSelector(),this.endHover()},_repositionHover:function(g){var f=this._builder.getControl($(g).data("cid"));if(!f){this._highlighter.hide();return}c=g.offset();f.getControlType()=="page"||f.getControlType()=="tabbar"?this._highlighter.addClass("noborder"):this._highlighter.removeClass("noborder");var i=f.getCalculatedMargin();if(i[3]<0&&i[1]<0){var h=i[3]+i[1];this._highlighter.css({left:c.left+i[1],top:c.top,width:g.outerWidth()-h,height:g.outerHeight()})}else{this._highlighter.css({left:c.left,top:c.top,width:g.width(),height:g.outerHeight()})}this._highlighter.show()},moveHover:function(h){if(!this._currentPageObj){return !1}if(this._isSorting===!0&&this._highlightedEl){this._repositionHover(this._highlightedEl);var g=this._builder.getSelectedControl();if(g){var l=g.getDeviceRenderedEl();this._highlightedEl.get(0)===l.get(0)&&this._repositionSelector(this._highlightedEl)}return !1}var k=$("[data-cid]",this._currentPageObj);for(var j=k.length-1;j>=0;j--){var i=k.eq(j);if(this._controlElementContains(i,h.pageX,h.pageY)&&this._isValidHoverTarget(i)){if(this._highlightedEl&&i.get(0)==this._highlightedEl.get(0)){return}this.endHover(),this.startHover(i);return}}},_isValidHoverTarget:function(e){var d=this._builder.getControl($(e).data("cid"));return d&&!this._builder.isSelectableControl(d)?!1:!0},_setCurrentPage:function(e){var d=this,f=$('body > div[data-cid="'+e+'"]');if(f.length<1){console.error("Unable to set current page with id",e,"it doesn't exist");return}this._currentPage=e,this._currentPageObj=f},getCurrentPage:function(){return !this._currentPageObj||this._currentPageObj.length<1?(this._currentPageObj=$('body > div[data-cid="'+this._currentPage+'"]'),this._currentPageObj):this._currentPageObj},setCurrentPage:function(e){var d=this,f=$('body > div[data-cid="'+e+'"]');if(f.length<1){console.error("Unable to set current page with id",e,"it doesn't exist");return}this._currentPage=e,this._currentPageObj=f,f.unbind("pageinit pagebeforecreate pagecreate pagebeforechange pagechange").bind("pageinit",function(){console.log("DEVICE: PAGE INIT",e),$(this).jqmData("alreadyCreated",!0)}).bind("pagebeforecreate",function(){console.log("DEVICE: PAGE BEFORE CREATE",e)}).bind("pagecreate",function(){console.log("DEVICE: PAGE CREATE",e)}).bind("pagebeforechange",function(){console.log("DEVICE: PAGE BEFORE CHANGE",e)}).bind("pagechange",function(){console.log("DEVICE: PAGE CHANGE",e)}),f.jqmData("alreadyCreated")&&f.trigger("pagecreate"),f.die("pageshow").live("pageshow",function(b,a){console.log("DEVICE: PAGE SHOW",e),d.onPageChanged()})},showPage:function(e){var d=$('body > div[data-cid="'+e+'"]');if(d.length<1){console.error("Unable to show page with control id",e,"it doesn't exist");return}console.log("DEVICE: showing page ",e),this.onAllControlsDeselected(),this.setCurrentPage(e),$.mobile.changePage($(this._currentPageObj))},refreshPage:function(){console.log("DEVICE: refreshing device"),$("table[data-role=table]").each(function(d,e){var b=this.id;$("#"+b+"-popup-screen, #"+b+"-popup-popup").remove()}),$.mobile.activePage?$.mobile.activePage.trigger("pagecreate"):setTimeout(function(){$.mobile.activePage.trigger("pagecreate")},11)},redrawActivePage:function(){if(!$.mobile.activePage||!this._builder||this._builder.isLoading()){return}var e=$.mobile.activePage.data("cid"),d=this._builder.getControl(e);if(!e||!d){return}this._builder.isPreviewMode()||(this._dirtyPages[e]===!0?(console.log("REDRAWING PAGE",e,"BECAUSE DIRTY"),this.updateControl(d),delete this._dirtyPages[e]):console.log("NOT REDRAWING PAGE",e,"BECAUSE NOT DIRTY"))},redrawAll:function(){var b=this._builder.getDocument().root;b.render(window.document),$("body").append(b.getDeviceRenderedEl().children()),this.refreshPage()},recreatePages:function(){$('[data-role="page"]').each(function(){try{$(this).trigger("pagecreate")}catch(b){}})},initAppPages:function(b){if(b.getControlType()!="app"){return}console.log("DEVICE: init app");b.render(window.document),$("body").append(b.getDeviceRenderedEl().children())},initControl:function(j){var i,p,o,n,m,l,k=this;if(this._builder.isLoading()){return}j.getControlType()=="app"?(j.render(window.document),$("body").append(j.getDeviceRenderedEl().children(":first"))):(i=$("body > div[data-cid]"),o=this._builder.getDocument().root,o.render(window.document),$("body").append(o.getDeviceRenderedEl().children()),j.getControlType()=="page"?(k.setCurrentPage(j.getId()),console.log("WOULD REFRESH PAGE!"),k.refreshPage()):this.refreshPage())},addControl:function(b){console.log("DEVICE: adding control",b.getId()),this.stopScrolling(),this.initControl(b),$(".shim").remove()},addControlToContainer:function(e,d,f){console.log("DEVICE: adding control to container",e.getId(),d.getId()),this.stopScrolling(),d.addChildAtPoint(e,f),this.initControl(e)},removeControl:function(e){var d=$('[data-cid="'+e.getId()+'"]');if(d.length<1){return null}if(e.getControlType()=="page"){var f=$('body > div[data-cid][data-cid!="'+e.getId()+'"]:first');this.setCurrentPage(f.data("cid")),setTimeout(function(){d.remove()},500)}else{if(e.getControlType()=="submitbutton"){d=d.closest("div.ui-submit");d.remove()}else{if(e.getControlType()==="pagefooter"){this._currentPageObj.removeClass("ui-page-footer-fixed"),d.remove()}else{d.remove()}}}return console.log("DEVICE: removed control: "+e.getId()),this.repositionCurrentSelector(),d},updateControl:function(b){b.render(window.document);var f=b.getDeviceExistingControl(jQuery);if(b.getControlType()=="page"){this._changePageTheme(f,$(f).attr("data-theme"),b.theme.getValue())}else{var e=f.attr("class");b.getControlType()==="gridblock"&&b.getDeviceRenderedEl().attr("class",e),f.replaceWith(b.getDeviceRenderedEl())}this.refreshPage(),this.repositionCurrentSelector(),this.endHover()},onControlRendered:function(e){console.log("DEVICE: control rendered ",e.getId()),this._initSortableControl(e);for(var d=0;d<e.children.length;d++){this._initSortableControl(e.children[d])}},_initSortableControl:function(e){console.log("DEVICE: init sortable control",e.getDeviceRenderedEl());var d=this;e.supportsSorting()&&$(e.getDeviceRenderedEl()).sortable({tolerance:"pointer",items:e.getSortableItemsSelector(),zIndex:18,cursor:"move",start:function(a,b){console.log("DEVICE: drag control start",b.item);var f=b.item;f.data("oldIndex",f.index()),d.startSorting()},change:function(a,b){d.repositionCurrentSelector()},stop:function(a,b){console.log("DEVICE: drag control stop",b.item);var f=b.item;d.trigger("controlMoved",f.data("cid"),e,f.data("oldIndex"),f.index()),d.endSorting()}})},_changePageTheme:function(i,h,n){$(i).attr("data-theme",n),h||(h="c");if($(i).attr("class")){var m=new RegExp("-"+h+"$");n="-"+n;var l=$(i).attr("class").split(" "),k=!1;for(var j in l){m.test(l[j])&&(k=!0,l[j]=l[j].replace(m,n))}$(i).attr("class",l.join(" "))}},_changePageBg:function(e,d){$(e).css("backgroundImage","url('"+d.bgImage.getValue()+"')"),$(e).css("backgroundRepeat",d.bgImageRepeat.getValue())},stopScrolling:function(){clearInterval(this._scrollTimeout)},scrollDown:function(){var b=$(document);clearInterval(this._scrollTimeout),this._scrollTimeout=setInterval(function(){var a=b.scrollTop();b.scrollTop(a+20)},30)},scrollUp:function(){var b=$(document);clearInterval(this._scrollTimeout),this._scrollTimeout=setInterval(function(){var a=b.scrollTop();b.scrollTop(a-20)},30)},scrollToControl:function(e){var d=e.getDeviceRenderedEl(),f=d.offset();window.scrollTo(0,f.top-$(window).height()/2)},designModeHint:function(){$("body").removeClass("preview").addClass("design"),this.initEvents(),this.enableSorting()},previewModeHint:function(){$("body").removeClass("design").addClass("preview"),this.onAllControlsDeselected(),this.endHover(),this.removeEvents(),this.removeSorting(),this.recreatePages(),$.mobile.activePage&&this.markPageDirty($.mobile.activePage.data("cid"))}});