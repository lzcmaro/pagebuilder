(function(a){a.fn.swapClass=function(c,b){return this.removeClass(c).addClass(b)};a.fn.switchClass=function(c,b){if(this.hasClass(c)){return this.swapClass(c,b)}else{return this.swapClass(b,c)}};a.fn.treeview=function(u){var p={method:"POST",datatype:"json",url:false,cbiconpath:"js/ext/jquery.tree/images/",icons:["checkbox_0.gif","checkbox_1.gif","checkbox_2.gif"],emptyiconpath:"js/ext/jquery.tree/images/s.gif",showcheck:false,showicon:true,oncheckboxclick:false,onnodeclick:false,onnodedblclick:false,cascadecheck:true,data:null,clicktoggle:true,theme:"bbit-tree-arrows"};a.extend(p,u);var o=p.data;var z=a(this);var n=z.attr("id");if(n==null||n==""){n="bbtree"+new Date().getTime();z.attr("id",n)}var k=[];r(p.data,k);z.addClass("bbit-tree").html(k.join(""));l(z);k=null;if(p.showcheck){for(var q=0;q<3;q++){var j=new Image();j.src=p.cbiconpath+p.icons[q]}}function r(E,C){C.push("<div class='bbit-tree-bwrap'>");C.push("<div class='bbit-tree-body'>");C.push("<ul class='bbit-tree-root ",p.theme,"'>");if(E&&E.length>0){var B=E.length;for(var D=0;D<B;D++){x(E[D],C,0,D,D==B-1)}}else{d(null,false,function(H){if(H&&H.length>0){o=H;p.data=H;var F=H.length;for(var G=0;G<F;G++){x(H[G],C,0,G,G==F-1)}}})}C.push("</ul>");C.push("</div>");C.push("</div>")}function x(E,H,I,J,B){var i=E.id.replace(/[^\w]/gi,"_");H.push("<li class='bbit-tree-node'>");H.push("<div id='",n,"_",i,"' tpath='",J,"' unselectable='on' title='",E.text,"'");var G=[];G.push("bbit-tree-node-el");if(E.hasChildren){G.push(E.isexpand?"bbit-tree-node-expanded":"bbit-tree-node-collapsed")}else{G.push("bbit-tree-node-leaf")}if(E.classes){G.push(E.classes)}H.push(" class='",G.join(" "),"'>");H.push("<span class='bbit-tree-node-indent'>");if(I==1){H.push("<img class='bbit-tree-icon' src='",p.emptyiconpath,"'/>")}else{if(I>1){H.push("<img class='bbit-tree-icon' src='",p.emptyiconpath,"'/>");for(var F=1;F<I;F++){H.push("<img class='bbit-tree-elbow-line' src='",p.emptyiconpath,"'/>")}}}H.push("</span>");G.length=0;if(E.hasChildren){if(E.isexpand){G.push(B?"bbit-tree-elbow-end-minus":"bbit-tree-elbow-minus")}else{G.push(B?"bbit-tree-elbow-end-plus":"bbit-tree-elbow-plus")}}else{G.push(B?"bbit-tree-elbow-end":"bbit-tree-elbow")}H.push("<img class='bbit-tree-ec-icon ",G.join(" "),"' src='",p.emptyiconpath,"'/>");if(p.showicon){H.push("<img class='bbit-tree-node-icon' src='",p.emptyiconpath,"'/>")}if(p.showcheck&&E.showcheck){if(E.checkstate==null||E.checkstate==undefined){E.checkstate=0}H.push("<img  id='",n,"_",i,"_cb' class='bbit-tree-node-cb' src='",p.cbiconpath,p.icons[E.checkstate],"'/>")}H.push("<a hideFocus class='bbit-tree-node-anchor' tabIndex=1 href='javascript:void(0);'>");H.push("<span unselectable='on'>",E.text,"</span>");H.push("</a>");H.push("</div>");if(E.hasChildren){H.push("<ul  class='bbit-tree-node-ct'  style='z-index: 0; position: static; visibility: visible; top: auto; left: auto;");H.push(" display:"+(E.isexpand?'""':"none;")+"'>");if(E.ChildNodes){var C=E.ChildNodes.length;for(var D=0;D<C;D++){E.ChildNodes[D].parent=E;x(E.ChildNodes[D],H,I+1,J+"."+D,D==C-1)}}H.push("</ul>")}H.push("</li>");E.render=true}function h(E){var D=E.split(".");var C=o;for(var B=0;B<D.length;B++){if(B==0){C=C[D[B]]}else{C=C.ChildNodes[D[B]]}}return C}function v(K,D,I){var F=K.checkstate;if(I==1){K.checkstate=D}else{var H=K.ChildNodes;var E=H.length;var C=true;for(var G=0;G<E;G++){if((D==1&&H[G].checkstate!=1)||D==0&&H[G].checkstate!=0){C=false;break}}if(C){K.checkstate=D}else{K.checkstate=2}}if(K.render&&F!=K.checkstate){var B=K.id.replace(/[^\w]/gi,"_");var J=a("#"+n+"_"+B+"_cb");if(J.length==1){J.attr("src",p.cbiconpath+p.icons[K.checkstate])}}}function f(F,G,C){if(F(G,C,1)!=false){if(G.ChildNodes!=null&&G.ChildNodes.length>0){var E=G.ChildNodes;for(var D=0,B=E.length;D<B;D++){f(F,E[D],C)}}}}function m(B,C,i){var D=C.parent;while(D){if(B(D,i,0)===false){break}D=D.parent}}function w(F){var E=a(this).attr("tpath");var D=F.target||F.srcElement;var C=h(E);if(D.tagName=="IMG"){if(a(D).hasClass("bbit-tree-elbow-plus")||a(D).hasClass("bbit-tree-elbow-end-plus")){var B=a(this).next();if(B.hasClass("bbit-tree-node-ct")){B.show()}else{var i=E.split(".").length;if(C.complete){C.ChildNodes!=null&&A(C.ChildNodes,i,E,B,C)}else{a(this).addClass("bbit-tree-node-loading");d(C,true,function(H){C.complete=true;C.ChildNodes=H;A(H,i,E,B,C)})}}if(a(D).hasClass("bbit-tree-elbow-plus")){a(D).swapClass("bbit-tree-elbow-plus","bbit-tree-elbow-minus")}else{a(D).swapClass("bbit-tree-elbow-end-plus","bbit-tree-elbow-end-minus")}a(this).swapClass("bbit-tree-node-collapsed","bbit-tree-node-expanded")}else{if(a(D).hasClass("bbit-tree-elbow-minus")||a(D).hasClass("bbit-tree-elbow-end-minus")){a(this).next().hide();if(a(D).hasClass("bbit-tree-elbow-minus")){a(D).swapClass("bbit-tree-elbow-minus","bbit-tree-elbow-plus")}else{a(D).swapClass("bbit-tree-elbow-end-minus","bbit-tree-elbow-end-plus")}a(this).swapClass("bbit-tree-node-expanded","bbit-tree-node-collapsed")}else{if(a(D).hasClass("bbit-tree-node-cb")){t(C);if(p.oncheckboxclick){p.oncheckboxclick.call(D,C,C.checkstate)}}}}}else{if(p.citem){var G=p.citem.id.replace(/[^\w]/gi,"_");a("#"+n+"_"+G).removeClass("bbit-tree-selected")}p.citem=C;a(this).addClass("bbit-tree-selected");if(p.onnodeclick){if(!C.expand){C.expand=function(){b.call(C)}}p.onnodeclick.call(this,C)}}}function g(D){var C=a(this).attr("tpath");var B=D.target||D.srcElement;var i=h(C);if(B.tagName!="IMG"){if(p.showcheck){t(i);if(p.oncheckboxclick){p.oncheckboxclick.call(B,i,i.checkstate)}}if(p.onnodedblclick){p.onnodedblclick.call(this,i)}}}function t(B,C){var i=C===undefined?(B.checkstate!=1?1:0):C;if(p.cascadecheck){f(v,B,i);m(v,B,i)}else{v(B,i,1)}}function b(){var B=this;var C=B.id.replace(/[^\w]/gi,"_");var i=a("#"+n+"_"+C+" img.bbit-tree-ec-icon");if(i.length>0){i.click()}}function A(D,C,I,G,H){var B=D.length;if(B>0){var E=[];for(var F=0;F<B;F++){D[F].parent=H;x(D[F],E,C,I+"."+F,F==B-1)}G.html(E.join(""));E=null;l(G)}G.addClass("bbit-tree-node-ct").css({"z-index":0,position:"static",visibility:"visible",top:"auto",left:"auto",display:""});G.prev().removeClass("bbit-tree-node-loading")}function d(B,i,D){if(p.url){if(B&&B!=null){var C=s(B)}a.ajax({type:p.method,url:p.url,data:C,async:i,dataType:p.datatype,success:D,error:function(E){alert("error occur!")}})}}function s(i){var B=[{name:"id",value:encodeURIComponent(i.id)},{name:"text",value:encodeURIComponent(i.text)},{name:"value",value:encodeURIComponent(i.value)},{name:"checkstate",value:i.checkstate}];return B}function y(){a(this).hover(function(){a(this).addClass("bbit-tree-node-over")},function(){a(this).removeClass("bbit-tree-node-over")}).click(w).dblclick(g).find("img.bbit-tree-ec-icon").each(function(i){if(!a(this).hasClass("bbit-tree-elbow")){a(this).hover(function(){a(this).parent().addClass("bbit-tree-ec-over")},function(){a(this).parent().removeClass("bbit-tree-ec-over")})}})}function l(B){var i=a("li.bbit-tree-node>div",B);i.each(y)}function c(F){var G=F.replace(/[^\w-]/gi,"_");var D=a("#"+n+"_"+G);if(D.length>0){D.addClass("bbit-tree-node-loading");var i=D.hasClass("bbit-tree-elbow-end")||D.hasClass("bbit-tree-elbow-end-plus")||D.hasClass("bbit-tree-elbow-end-minus");var E=D.attr("tpath");var B=E.split(".").length;var C=h(E);if(C){d(C,true,function(J){C.complete=true;C.ChildNodes=J;C.isexpand=true;if(J&&J.length>0){C.hasChildren=true}else{C.hasChildren=false}var I=[];x(C,I,B-1,E,i);I.shift();I.pop();var H=D.parent();H.html(I.join(""));I=null;l(H);y.call(H.find(">div"))})}}else{alert("\u8be5\u8282\u70b9\u8fd8\u6ca1\u6709\u751f\u6210")}}function e(C,F,E){for(var D=0,B=C.length;D<B;D++){(C[D].showcheck==true&&C[D].checkstate!=0)&&F.push(E(C[D]));if(C[D].ChildNodes!=null&&C[D].ChildNodes.length>0){e(C[D].ChildNodes,F,E)}}}z[0].t={getSelectedNodes:function(){var i=[];e(o,i,function(B){return B});return i},getSelectedValues:function(){var i=[];e(o,i,function(B){return B.value});return i},getCurrentItem:function(){return p.citem},getNodeFromPath:function(i){return h(i)},setCheckedNodes:function(D){if(!p.showcheck){return}var F,G,B=z.find("div.bbit-tree-node-el"),E=a.trim(D).split(",");z.find("div.bbit-tree-node-el").each(function(H,I){F=h(a(this).attr("tpath"));if(F.checkstate!==0){t(F,0)}});for(var C=E.length;C>=0;C--){B.each(function(i,H){F=h(a(this).attr("tpath"));if(E[C]===F.id&&F.checkstate===0){t(F,1);return false}})}},reflash:function(i){var B;if(typeof(i)=="string"){B=i}else{B=i.id}c(B)}};return z};a.fn.getTSVs=function(){if(this[0].t){return this[0].t.getSelectedValues()}return null};a.fn.getTSNs=function(){if(this[0].t){return this[0].t.getSelectedNodes()}return null};a.fn.getTCT=function(){if(this[0].t){return this[0].t.getCurrentItem()}return null};a.fn.getTN=function(b){if(this[0].t){return this[0].t.getNodeFromPath(b)}return null};a.fn.setTSNs=function(b){if(this[0].t){return this[0].t.setCheckedNodes(b)}};a.fn.reflash=function(b){if(this[0].t){return this[0].t.reflash(b)}}})(jQuery);
