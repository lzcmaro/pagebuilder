SETTINGS={DeviceOrientation:{LANDSCAPE:0,PORTRAIT:1},DeviceSizes:{_240x320:[240,320],_320x480:[320,480],_480x800:[480,800],_600x1024:[600,1024],_640x960:[640,960],_640x1136:[640,1136],_720x1280:[720,1280],_768x1024:[768,1024],_800x1280:[800,1280]},InterfaceModes:{DESIGN:1,PREVIEW:2,CODE:3},ActionTypes:{ADD:1,REMOVE:2,MOVE_FORWARD:3,MOVE_BACK:4,PROPERTY_FORWARD:5,PROPERTY_BACK:6},ControlAppendMode:{CONTENT_APPEND:0,CONTENT_PREPEND:1,PAGE_APPEND:2,PAGE_PREPEND:3,HEADER_PREPEND:4,HEADER_APPEND:5,FOOTER_PREPEND:6,FOOTER_APPEND:7},ICONS:[{value:"",key:""},{value:"arrow-l",key:"左箭头"},{value:"arrow-r",key:"右箭头"},{value:"arrow-u",key:"上箭头"},{value:"arrow-d",key:"下箭头"},{value:"delete",key:"删除"},{value:"plus",key:"加号"},{value:"minus",key:"减号"},{value:"check",key:"确认"},{value:"gear",key:"齿轮"},{value:"refresh",key:"刷新"},{value:"forward",key:"前进"},{value:"back",key:"返回"},{value:"grid",key:"栅格"},{value:"star",key:"星号"},{value:"alert",key:"警告"},{value:"info",key:"信息"},{value:"home",key:"首页"},{value:"search",key:"搜索"}],TRANSITIONS:[{value:"none",key:"无"},{value:"fade",key:"渐变"},{value:"pop",key:"弹出"},{value:"flip",key:"翻转"},{value:"turn",key:"转动"},{value:"flow",key:"流动"},{value:"slidefade",key:"滑动渐变"},{value:"slide",key:"滑动"},{value:"slideup",key:"向上滑动"},{value:"slidedown",key:"向下滑动"}],THEMES:[{value:"",key:"默认"},{value:"a",key:"黑色"},{value:"b",key:"蓝色"},{value:"c",key:"灰色"},{value:"e",key:"黄色"}],ISFIXED:[{value:"",text:"否"},{value:"fixed",text:"是"}],SIZE:[{value:1,text:"1"},{value:2,text:"2",selected:!0},{value:3,text:"3"},{value:4,text:"4"},{value:5,text:"5"}],ISREADONLY:[{value:"true",text:"是"},{value:"false",text:"否"}],_ISCOLLAPSED:[{value:"false",text:"否"},{value:"true",text:"是"}],DISPLAYINSET:[{value:"true",text:"是"},{value:"false",text:"否"}],COLUMNS:[{value:"2",text:"2",selected:!0},{value:"3",text:"3"},{value:"4",text:"4"},{value:"5",text:"5"}],ROWS:[{value:"1",text:"1",selected:!0},{value:"2",text:"2"},{value:"3",text:"3"},{value:"4",text:"4"},{value:"5",text:"5"},{value:"6",text:"6"}],OPENNEWWINDOW:[{value:"true",text:"是"},{value:"false",text:"否"}],ISINLINE:[{value:"false",text:"否"},{value:"true",text:"是"}],ISREVERSETRANSITION:[{value:"false",text:"否"},{value:"true",text:"是"}],ISBACKBUTTON:[{value:"false",text:"否"},{value:"true",text:"是"}],ALIGN:[{value:"left",text:"左"},{value:"center",text:"中"},{value:"right",text:"右"}],DISPLAYMODE:[{value:"block",text:"块"},{value:"inline",text:"行"}],ISMINI:[{value:"false",text:"否"},{value:"true",text:"是"}],ORIENTATION:[{value:"vertical",text:"垂直",selected:!0},{value:"horizontal",text:"水平"}],ISNATIVE:[{value:"false",text:"否"},{value:"true",text:"是"}],ACTION:[{value:"GET",text:"GET"},{value:"POST",text:"POST"}],AJAX:[{value:"false",text:"否"},{value:"true",text:"是"}],ISHIGHLIGHT:[{value:"false",text:"否"},{value:"true",text:"是"}],INPUTTYPE:[{value:"text",text:"文本",selected:!0}],ISACTIVE:[{value:!1,text:"否"},{value:!0,text:"是"}],CONTROLNAMES:{page:"页面",pageheader:"页头",heading:"标题",pagecontent:"",navbar:"导航栏",pagefooter:"页脚",listview:"列表",collapsible:"可折叠文本",collapsiblecontent:"",grid:"网格",gridblock:"单元格",text:"文本块",link:"链接",button:"普通按钮",image:"图片",submitbutton:"提交按钮",form:"表单",textinput:"单行文本框",textarea:"多行文本框",radio:"单选按钮",radiobuttons:"单选按钮",checkboxes:"复选按钮",checkbox:"复选按钮",selectmenu:"下拉选择框",slider:"滑动条",video:"视频",audio:"语音",googlemaps:"地图",datatable:"数据表格",html:"HTML源码"},WIDGETTABS:{toolsBar:"工具栏",button:"按钮",content:"内容",form:"表单"},FONTFAMILY:[{value:"宋体",text:"宋体"},{value:"微软雅黑",text:"微软雅黑"},{value:"黑体",text:"黑体"},{value:"楷体",text:"楷体"},{value:"幼园",text:"幼园"},{value:"隶书",text:"隶书"},{value:"Arial",text:"Arial"},{value:"Arial Black",text:"Arial Black"},{value:"Book Antiqua",text:"Book Antiqua"},{value:"Courier New",text:"Courier New"},{value:"Tahoma",text:"Tahoma"},{value:"Verdana",text:"Verdana"}],FONTSIZE:[{value:"xx-small",text:"1(8pt)"},{value:"x-small",text:"2(10pt)"},{value:"small",text:"3(12pt)"},{value:"medium",text:"4(14pt)"},{value:"large",text:"5(18pt)"},{value:"x-large",text:"6(24pt)"},{value:"xx-large",text:"7(36pt)"}],FONTCOLOR:["#000000","#993300","#333300","#003300","#003366","#000080","#333399","#333333","#800000","#FF6600","#808000","#008000","#008080","#0000FF","#666699","#808080","#FF0000","#FF9900","#99CC00","#339966","#33CCCC","#3366FF","#800080","#999999","#FF00FF","#FFCC00","#FFFF00","#00FF00","#00FFFF","#00CCFF","#993366","#C0C0C0","#FF99CC","#FFCC99","#FFFF99","#CCFFCC","#CCFFFF","#99CCFF","#CC99FF","#FFFFFF"]};Layout=Backbone.View.extend({initialize:function(c){this._control=c},render:function(){}}),BoxLayout=Layout.extend({initialize:function(c){Layout.prototype.initialize.call(this,c)},render:function(h){var n=this._control.children,m=h.createElement("div");for(var l=0;l<n.length;l++){var k=n[l];k.render(h);var j=k.getDeviceRenderedEl();$(m).append(j)}this.el=m},renderTo:function(j){var h=this._control.children;for(var m=0;m<h.length;m++){var l=h[m],k=document.createElement("div");l.renderTo(k),$(j).append($(k).contents())}},quickRenderTo:function(){var j=document.createElement("div"),h=this._control.children;for(var m=0;m<h.length;m++){var l=h[m],k=document.createElement("div");l.renderTo(k),$(j).append($(k).contents())}return j}}),GridLayout=Layout.extend({initialize:function(c){Layout.prototype.initialize.call(this,c),this._gridColMap={0:"a",1:"b",2:"c",3:"d",4:"e"}},render:function(x){var v=this._control.children,u=x.createElement("div"),t=parseInt(this._control.rows.getValue()),s=parseInt(this._control.columns.getValue());for(var r=0;r<v.length;r++){var q=Math.floor(r/t),p=Math.floor(r%s),o=v[r];o.render(x);var n=this._gridColMap[p],m=o.getDeviceRenderedEl();m.removeClass("ui-block-a"),m.removeClass("ui-block-b"),m.removeClass("ui-block-c"),m.removeClass("ui-block-d"),m.removeClass("ui-block-e"),m.addClass("ui-block-"+n),$(u).append(m)}this.el=u},renderTo:function(t){var s=this._control.children,r=parseInt(this._control.rows.getValue()),q=parseInt(this._control.columns.getValue());for(var p=0;p<s.length;p++){var o=Math.floor(p/r),n=Math.floor(p%q),m=s[p],l=document.createElement("div"),k=this._gridColMap[n];m.renderTo(l),$(":first",l).addClass("ui-block-"+k),$(t).append($(l).contents())}}});InputFilter=Backbone.Model.extend({accept:function(){}}),AcceptAllInputFilter=InputFilter.extend({accept:function(){return !0}}),AcceptPageIDInputFilter=InputFilter.extend({accept:function(c){return c.indexOf(" ")>=0?!1:!0}}),AcceptUrlInputFilter=InputFilter.extend({accept:function(c){return c.indexOf("http://")>=0}});Widget=Backbone.View.extend({initialize:function(d,c){this._template=d,this._data={},c||(this._filter=new AcceptAllInputFilter)},setValue:function(c){c&&(this._data=c)},updateValue:function(c){this.setValue(c)},render:function(j){var h="#template-widget-"+this._template,l=Handlebars.compile($(h).html()),k=l($.extend(this._data,{_property_title:j,_wid:this.cid}));$(this.el).html(k),this.delegateEvents()},onAttach:function(){}});_.extend(Widget,Backbone.Events);NullWidget=Widget.extend({initialize:function(){Widget.prototype.initialize.call(this,"nullwidget",new AcceptAllInputFilter)}}),SingleTextWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"singletext",d),this._delay=c||500,this._data={text:""}},events:{"keyup input":"onKeyPress","change input":"onValueChange","keydown input":"onKeyDown"},setValue:function(c){this._data.text=c,$("input[type=text]",this.el).val(c)},updateValue:function(c){this._data.text=c},onKeyDown:function(c){return(c.ctrlKey||c.metaKey)&&c.which==90?(window.App.undo(),!1):(c.ctrlKey||c.metaKey)&&c.which==89?(window.App.redo(),!1):!0},onValueChange:function(d,c){if(c){this.onKeyPress.call(this,d)}},onKeyPress:function(h){var d=this,j=$(h.currentTarget);this._delay?(clearTimeout(this._delayTimeout),this._delayTimeout=setTimeout(function(){d.trigger("valueChanged",j.val())},this._delay)):this.trigger("valueChanged",j.val())}}),PixelSizeWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"pixelsize",d),this._data=c},events:{"keyup input":"onKeyPress","keydown input":"onKeyDown",'change input[type="radio"]':"onRadioChange"},setValue:function(c){this._data=c,$("input[type=text].val",this.el).val(c.value),$('input[type=radio][value="'+c.units+'"]',this.el).attr("checked","checked")},updateValue:function(c){this._data=c},onKeyDown:function(c){return(c.ctrlKey||c.metaKey)&&c.which==90?(window.App.undo(),!1):(c.ctrlKey||c.metaKey)&&c.which==89?(window.App.redo(),!1):!0},_valueChanged:function(){var d=$(this.el).find(".val").val(),c=$(this.el).find('input[type="radio"]:checked').val();this.trigger("valueChanged",{value:d,units:c})},onKeyPress:function(c){this._valueChanged()},onRadioChange:function(d){var c=$(d.currentTarget);this._valueChanged()}}),SelectWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"select",d),this._data={options:c}},events:{"change select":"onValueChanged"},onValueChanged:function(d){var c=$(d.currentTarget);this.trigger("valueChanged",c.val())},setValue:function(h){for(var d in this._data.options){var j=this._data.options[d];j.selected=!1,j.value==h&&(j.selected=!0)}}}),ThemeSelectWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"themeselect",d),this._data={themes:$.extend(!0,[],SETTINGS.THEMES)}},events:{"change select":"onValueChanged"},onValueChanged:function(d){var c=$(d.currentTarget);this.trigger("valueChanged",c.val())},setValue:function(h){for(var d in this._data.themes){var j=this._data.themes[d];j.selected=!1,j.value==h&&(j.selected=!0)}}});ThemeSelectorWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"themeselector",d),this._data={themes:$.extend(!0,[],SETTINGS.THEMES)};this._data.themes.splice(0,1)},events:{"click a":"onThemeSelected"},onThemeSelected:function(c){var h=$(c.currentTarget);h.hasClass("selected")||(h.siblings("a").removeClass("selected"),h.addClass("selected"),this.trigger("valueChanged",h.attr("val")))},setValue:function(h){for(var d in this._data.themes){var j=this._data.themes[d];j.selected=!1,j.value==h&&(j.selected=!0)}}});ListWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,d,c),this._data={items:[]}},events:{"click div.add":"onItemAdded","click a.remove":"onItemDeleted","keyup input":"onItemChanged","change select":"onItemChanged"},setValue:function(c){this._data.items=c},render:function(j){var h="#template-widget-"+this._template,m=Handlebars.compile($(h).html()),l=m($.extend(this._data,{_property_title:j})),k=this;$(this.el).html(l),$(".fg-accordion.sortable",this.el).accordion({active:":last",autoHeight:!1,animated:!1,collapsible:!0,clearStyle:!0,header:"> div > h3",icons:{header:"bui-icon bui-icon-plus",headerSelected:"bui-icon bui-icon-minus"}}).sortable({axis:"y",handle:"h3",tolerance:"pointer",start:function(n,d){var o=d.item.index();d.item.data("contentDragStart",o)},change:function(n,d){var o=d.item.index()},stop:function(o,n){$(this).data("_stop",!0);var q=n.item.data("contentDragStart"),p=n.item.index();k.trigger("itemMoved",q,p)}}),$(".fg-collapsible.sortable h3").click(function(d){var c=$(this).closest(".fg-collapsible.sortable");c.data("_stop")===!0&&(d.stopImmediatePropagation(),d.preventDefault(),c.data("_stop",!1))}),this.delegateEvents()},getItemData:function(d,c){},onItemAdded:function(){this.trigger("itemAdded",this.getItemData("add"))},onItemChanged:function(j){var h=$(j.currentTarget),n=h.closest(".fg-collapsible"),m=$(n).index(),l=this.getItemData("change",n),k=$("h3 span",n);console.log("Changing item",m),l.text&&$("h3",n).html("").append(k).append(l.text),this.trigger("itemChanged",m,l)},onItemDeleted:function(j){var h=$(j.currentTarget),l=h.closest(".fg-collapsible"),k=$(l).index();console.log("Deleting button",k),this.trigger("itemDeleted",k),l.remove()}});Handlebars.registerHelper("buttonlistitems_render",function(G,F){var E=[];for(var D=0;D<G.length;D++){var C=G[D],B=new UrlOrPageSelectWidget;B.setValue(C.url),B.render();var A=$(B.el).html(),z=new IconSelectWidget(IconSelectWidget.ICON_ONLY);z.setValue(C.icon),z.render();var y=$(z.el).html(),x=new ThemeSelectWidget;x.setValue(C.theme),x.render();var v=$(x.el).html(),u=new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ISACTIVE));u.setValue(C.isActive=="true"),u.render();var t=$(u.el).html(),s="#sub-template-widget-buttonlistitems",r=Handlebars.compile($(s).html()),q=r($.extend({iconSelect:y,pageSelect:A,themeSelect:v,isActiveSelect:t},C));E.push(q)}return E.join("")});ButtonListItemWidget=ListWidget.extend({initialize:function(c){ListWidget.prototype.initialize.call(this,"buttonlistitems",c)},render:function(c){ListWidget.prototype.render.call(this,c);this.$("select.pages").bind("change",function(d){var a=$(this);if(a.val()==="URL"){var h=prompt("请输入链接地址：(例如：http://www.google.com)                                               ");h?(a.find("option:not(.page)").remove(),a.append('<option value="'+h+'" selected>'+h+'</option><option value="URL">URL...</option>')):a.find("option:first").attr("selected",true)}})},getItemData:function(j,h){var k=j==="add",l=k?window.App.getCurrentPage().getId()||"":$("select.pages",h).val();if(/page[\d]+/.test(l)){l="#"+l}return{text:k?"按钮":$("input",h).val(),icon:k?"arrow-u":$("select.icons",h).val(),url:l,theme:k?"":$("select.themes",h).val(),isActive:k?!1:$(".isActive select",h).val()}}}),IconSelectWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"iconselect",c),this._data={align:"left",icons:$.extend(!0,[],SETTINGS.ICONS)},d==IconSelectWidget.ICON_ONLY&&(this._data.align=null),d==IconSelectWidget.ALIGN_ONLY&&(this._data.icons=null)},events:{"change select":"onValueChanged","click a":"onAlignChanged"},onAlignChanged:function(j){var h=$(j.currentTarget),l=h.data("align"),k=$("select",this.el).val();return this._data.align=l,this.trigger("valueChanged",{icon:k,align:l}),!0},onValueChanged:function(h){var d=$(h.currentTarget),j=$(d).val();this.trigger("valueChanged",{icon:j,align:this._data.align})},setValue:function(j){for(var h in this._data.icons){var l=this._data.icons[h];l.selected=!1;if(l.value===j.icon||l.value===j){l.selected=!0}}if(j.align){this._data.align=j.align;var k=$(".radio-set",this.el);k.length>0&&($(".radio",this.el).removeClass("selected"),$('.radio[data-align="'+j.align+'"]',this.el).addClass("selected"))}}},{ICON_ONLY:1,ICON_ALIGN:2,ALIGN_ONLY:3}),PageSelectWidget=Widget.extend({render:function(j){var h=window.App.getPages(),k=this._selectedPage?this._selectedPage.replace(/^#/,""):"";this._data.pages=[],this._allowEmpty&&this._data.pages.push({key:"",value:"",selected:!0});for(var m=0;m<h.length;m++){var l=h[m];this._data.pages.push({key:l.title.getValue(),value:l.getId(),selected:l.getId()===k})}Widget.prototype.render.call(this,j)},initialize:function(h,d){var j=this;Widget.prototype.initialize.call(this,"pageselect",h),this._allowEmpty=d,j._selectedPage=null},events:{"change select":"onValueChanged"},onValueChanged:function(d){var c=$(d.currentTarget);this.trigger("valueChanged",c.val())},setValue:function(c){this._selectedPage=c}}),TransitionSelectWidget=Widget.extend({initialize:function(c){Widget.prototype.initialize.call(this,"transitionselect",c),this._data={align:"left",transitions:$.extend(!0,[],SETTINGS.TRANSITIONS)}},events:{"change select":"onValueChanged"},onValueChanged:function(h){var d=$(h.currentTarget),j=$(d).val();this.trigger("valueChanged",j)},setValue:function(h){for(var d in this._data.transitions){var j=this._data.transitions[d];j.selected=!1,j.value==h&&(j.selected=!0)}}});Handlebars.registerHelper("listitems_render",function(C,B){var A=[];for(var z=0;z<C.length;z++){var y=C[z],x=new UrlOrPageSelectWidget;x.setValue(y.url),x.render();var v=$(x.el).html(),u=new TransitionSelectWidget;u.setValue(y.transition),u.render();var t=$(u.el).html(),s=new ThemeSelectWidget;s.setValue(y.theme),s.render();var r=$(s.el).html(),q="#sub-template-widget-listitems",p=Handlebars.compile($(q).html()),o=p($.extend({pageSelect:v,transitionSelect:t,themeSelect:r},y));A.push(o)}return A.join("")});var ListViewItemsWidget=ListWidget.extend({initialize:function(c){ListWidget.prototype.initialize.call(this,"listitems",c)},events:{"click div.add-button":"onItemAdded","click div.add-divider":"onDividerItemAdded","click a.remove":"onItemDeleted","keyup input":"onItemChanged","change select":"onItemChanged"},render:function(c){ListWidget.prototype.render.call(this,c);this.$("select.pages").bind("change",function(d){var a=$(this);if(a.val()==="URL"){var h=prompt("请输入链接地址：(例如：http://www.google.com)                                               ");h?(a.find("option:not(.page)").remove(),a.append('<option value="'+h+'" selected>'+h+'</option><option value="URL">URL...</option>')):a.find("option:first").attr("selected",true)}})},getItemData:function(j,h){var k=j==="add",l=k?window.App.getCurrentPage().getId()||"":$("select.pages",h).val();if(/page[\d]+/.test(l)){l="#"+l}return{text:k?"按钮":$("input.text",h).val(),url:l,count:k?null:$("input.count",h).val()||null,theme:k?"":$("select.themes",h).val(),transition:k?"":$("select.transitions",h).val(),isDivider:k?!1:h.data("isdivider")===!0}},onDividerItemAdded:function(h){var d=$("input[type=text]",this.el).val(),j=$("select.themes",this.el).val();j==""&&(j="b"),this.trigger("itemAdded",{isDivider:!0,text:"分栏",theme:j})}});Handlebars.registerHelper("collapsiblesections_render",function(t,s){var r=[];for(var q=0;q<t.length;q++){var p=t[q],o=new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS._ISCOLLAPSED));o.setValue(p.isCollapsed),o.render();var n=$(o.el).html(),m="#sub-template-widget-collapsiblesections",l=Handlebars.compile($(m).html()),k=l($.extend({isCollapsedSelect:n},p));r.push(k)}return r.join("")});var AccordionSectionItemWidget=ListWidget.extend({initialize:function(c){ListWidget.prototype.initialize.call(this,"collapsiblesections",c)},getItemData:function(h,c){var j=h==="add";return{text:j?"标题":$("input",c).val(),isCollapsed:j?!1:$(".is-collapsed select",c).val(),_controlId:j?null:this._data.items[c.index()]._controlId}}}),TextEditorWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"texteditor",d),this._data={text:c}},setValue:function(c){this._data.text=c,$("textarea",this.el).val(c)},updateValue:function(c){this._data.text=c},onAttach:function(){var c=this;$(".mceListBoxMenu, .mce_forecolor, .mce_backcolor").remove();tinyMCE.init({theme:"advanced",mode:"exact",valid_elements:"*[*]",elements:this.cid,language:"zh-cn",theme_advanced_toolbar_location:"top",theme_advanced_resizing:!1,plugins:"table,inlinepopups",theme_advanced_buttons1:"bold,italic,underline,strikethrough,table,|,justifyleft,justifycenter,justifyright,|,bullist,numlist,|,outdent,indent,|,code",theme_advanced_buttons2:"fontselect,fontsizeselect,|,link,unlink,|,image,|,forecolor,backcolor",theme_advanced_buttons3:"",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_source_editor_width:600,theme_advanced_source_editor_height:350,verify_html:!1,width:"350",height:"260",setup:function(a){a.onClick.add(function(h,l){var k=h.getContent(),j="在这里输入内容...";k=k.replace(/<[^>]+>/g,""),j===$.trim(k)&&h.setContent("")}),a.onKeyUp.add(function(d,h){c.trigger("valueChanged",d.getContent())})},onchange_callback:function(a){c.trigger("valueChanged",a.getContent())}})}}),UrlOrPageSelectWidget=Widget.extend({render:function(j){var h=window.App.getPages(),m=!1;this._data.pages=[];for(var l=0;l<h.length;l++){var k=h[l];k.getId()===this._selectedPage||"#"+k.getId()==this._selectedPage?(m=!0,this._data.pages.push({key:k.title.getValue(),value:k.getId(),selected:!0})):this._data.pages.push({key:k.title.getValue(),value:k.getId(),selected:!1})}Widget.prototype.render.call(this,j),$(this.el).find("option:not(.page)").remove(),!m&&this._selectedPage&&$(this.el).find("select").append('<option value="'+this._selectedPage+'" selected>'+this._selectedPage+"</option>"),$(this.el).find("select").append('<option value="URL">URL...</option>')},initialize:function(d){var c=this;Widget.prototype.initialize.call(this,"pageselect",d),c._selectedPage=null},events:{"change select":"onValueChanged"},onValueChanged:function(h){var d=$(h.currentTarget);if(d.val()==="URL"){var j=prompt("请输入链接地址：(例如：http://www.google.com)                                               ");j?(this.trigger("valueChanged",j),d.find("option:not(.page)").remove(),d.append('<option value="'+j+'" selected>'+j+'</option><option value="URL">URL...</option>')):d.get(0).selectedIndex=this._lastOptionIndex}else{if(Utils.ValidUrl(d.val())){this.trigger("valueChanged",d.val())}else{this.trigger("valueChanged","#"+d.val())}}},setValue:function(c){this._selectedPage=c}});Handlebars.registerHelper("image_render",function(t,s){var r=new PixelSizeWidget;r.setValue(t.width),r.render();var q=new PixelSizeWidget;q.setValue(t.height),q.render();var p=new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ALIGN));p.setValue(t.align),p.render();var o=new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.DISPLAYMODE));o.setValue(t.displayMode),o.render();var n=new UrlOrPageSelectWidget(new AcceptAllInputFilter);n.setValue(t.link),n.render();var m="#sub-template-widget-image",l=Handlebars.compile($(m).html()),k=l($.extend({url:t.url,widthSetting:"<div class='fe'>"+$(".fe",r.el).html()+"</div>",heightSetting:"<div class='fe'>"+$(".fe",q.el).html()+"</div>",alignSelect:$(p.el).html(),displaySelect:$(o.el).html(),linkSelect:$(n.el).html()},t));return k});ImageWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"image",d),this._data={image:c}},events:{"keydown input[type=text]":"onKeyDown","keyup input[type=text]":"onKeyPress","click .image-width input[type=radio], .image-height input[type=radio]":"onUnitsChanged","change .image-align select":"onAlignChanged","change .image-display select":"onDisplayModeChanged","change .image-link select":"onLinkChanged","click .tabs-header li:not(.active)":"onTabsClick","click .tabs-content li:not(.active)":"onImgItemClick","click .tabs-content li a.remove":"onItemDelete"},setValue:function(c){this._data.image=c},onKeyDown:function(c){return(c.ctrlKey||c.metaKey)&&c.which==90?(window.App.undo(),!1):(c.ctrlKey||c.metaKey)&&c.which==89?(window.App.redo(),!1):!0},onKeyPress:function(c){this._changed()},onUnitsChanged:function(c){this._changed()},onAlignChanged:function(c){this._changed()},onDisplayModeChanged:function(){this._changed()},onLinkChanged:function(j){var h=$(j.currentTarget),l=h.val();if(l=="URL"){var k=prompt("请输入链接地址：(例如：http://www.google.com)                                               ");k?(h.find("option:not(.page)").remove(),h.append('<option value="'+k+'" selected>'+k+'</option><option value="URL">URL...</option>')):h.find("option:first").attr("selected",true)}this._changed()},_changed:function(){var c;this.trigger("valueChanged",{url:$(".image-url input[type=text]",this.el).val(),width:{value:$(".image-width input[type=text]",this.el).val(),units:$(".image-width input[type=radio]:checked",this.el).val()},height:{value:$(".image-height input[type=text]",this.el).val(),units:$(".image-height input[type=radio]:checked",this.el).val()},align:$(".image-align select",this.el).val(),displayMode:$(".image-display select",this.el).val(),link:(c=$(".image-link select",this.el).val(),c.indexOf("page")===0?("#"+c):c)})},onTabsClick:function(h){var d=this,j=$(h.currentTarget);j.siblings().removeClass("active"),j.addClass("active"),$(".tabs-content",d.el).hide(),$(".tabs-content:eq("+j.index()+")",d.el).show().find("li").removeClass("active"),d._loadImageResouces()},onItemDelete:function(h){var d=window.App,k=$(h.currentTarget),j=k.attr("data-id");Utils.confirm("您确定要删除该张图片？",function(){Utils.request({url:d.getSitePath()+"deleteFileById.action",data:{id:j},async:false,loader:false,success:function(a){$("li[id="+j+"]",$(".tabs-content")).remove()}})});return false},onImgItemClick:function(h){var d=this,j=$(h.currentTarget);j.siblings().removeClass("active"),j.addClass("active"),$(".image-url input[type=text]",d.el).val(j.find("img").attr("src")),d._changed()},onAttach:function(){var j=this,h=window.App.getSitePath(),l=null,k=new qq.FileUploader({element:$(".image-uploader",j.el).get(0),listElement:$(".image-upload-list",j.el).get(0),action:h+"imageUpload.action?token="+Utils.getQueryParameter("token"),disableDefaultDropzone:true,autoUpload:true,inputName:"image",uploadButtonText:"上传图片",cancelButtonText:"取消",failUploadText:"上传失败",allowedExtensions:["gif","png","jpeg","jpg"],sizeLimit:1024*1024,forceMultipart:true,customErrorTips:function(d,a){var c=d.lastChild.lastChild;c.nodeValue+=", 原因:"+a.error},onSubmit:function(){l=$(".tabs-header li.active",j.el).index()},onComplete:function(o,n,m){if(m.success){var d=h+m.filepath.substr(1),c=$(".tabs-content:eq("+l+") ul",j.el),a=c.parent();window.App.putImageResouce({relativeUrl:m.filepath,id:m.id}),c.append("<li id="+m.id+"><img src='"+d+"' /><a href='' title='删除' data-id="+m.id+" class='remove'></a></li>"),a.scrollTop(a.offset().top),$("li:last",c).trigger("click")}setTimeout(function(){$(".image-upload-list",j.el).html("")},2500)},onError:function(m,c,a){}});j._loadImageResouces()},_loadImageResouces:function(){console.log("ImageWidget: loading image resouces.");var j=this,h=$(".tabs-header li.active",j.el),m=h.index();if(!h.data("init")){var l=window.App.getImageResouces(),k="";$.each(l,function(a,c){k+="<li id="+c.id+"><img src='"+window.App.getSitePath()+c.relativeUrl.substr(1)+"' /><a href='' data-id="+c.id+" title='删除' class='remove'></a></li>"}),$(".tabs-content:eq("+m+") ul",j.el).html(k),h.data("init",!0)}}});Handlebars.registerHelper("video_render",function(r,q){var p=new PixelSizeWidget;p.setValue(r.width),p.render();var o=new PixelSizeWidget;o.setValue(r.height),o.render();var n=new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ALIGN));n.setValue(r.align),n.render();var m=new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.DISPLAYMODE));m.setValue(r.displayMode),m.render();var l="#sub-template-widget-video",k=Handlebars.compile($(l).html()),j=k($.extend({url:r.url,widthSetting:"<div class='fe'>"+$(".fe",p.el).html()+"</div>",heightSetting:"<div class='fe'>"+$(".fe",o.el).html()+"</div>",alignSelect:$(n.el).html(),displaySelect:$(m.el).html()},r));return j});VideoWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"video",d),this._data={video:c}},events:{"keydown input[type=text]":"onKeyDown","keyup input[type=text]":"onKeyPress","click .video-width input[type=radio], .video-height input[type=radio]":"onUnitsChanged","change .video-align select":"onAlignChanged","change .video-display select":"onDisplayModeChanged","click .tabs-header li:not(.active)":"onTabsClick","click .tabs-content li:not(.active)":"onVideoItemClick"},setValue:function(c){this._data.video=c},onKeyDown:function(c){return(c.ctrlKey||c.metaKey)&&c.which==90?(window.App.undo(),!1):(c.ctrlKey||c.metaKey)&&c.which==89?(window.App.redo(),!1):!0},onKeyPress:function(c){this._changed()},onUnitsChanged:function(c){this._changed()},onAlignChanged:function(c){this._changed()},onDisplayModeChanged:function(){this._changed()},_changed:function(){this.trigger("valueChanged",{thumbnail:$("li.active img",this.el).attr("src"),fileSize:$("li.active img",this.el).attr("fileSize"),url:$(".video-url input[type=text]",this.el).val(),width:{value:$(".video-width input[type=text]",this.el).val(),units:$(".video-width input[type=radio]:checked",this.el).val()},height:{value:$(".video-height input[type=text]",this.el).val(),units:$(".video-height input[type=radio]:checked",this.el).val()},align:$(".video-align select",this.el).val(),displayMode:$(".video-display select",this.el).val()})},onTabsClick:function(h){var d=this,j=$(h.currentTarget);j.siblings().removeClass("active"),j.addClass("active"),$(".tabs-content",d.el).hide(),$(".tabs-content:eq("+j.index()+")",d.el).show().find("li").removeClass("active"),d._loadVideoResouces()},onVideoItemClick:function(h){var d=this,j=$(h.currentTarget);j.siblings().removeClass("active"),j.addClass("active"),$(".video-url input[type=text]",d.el).val(j.find("img").attr("videoPath")),$(".fe input.ui-input-text").val(j.find("img").attr("title")).trigger("change",!0),d._changed()},onAttach:function(){var j=this,h=window.App.getSitePath(),l=null,k=new qq.FileUploader({element:$(".video-uploader",j.el).get(0),listElement:$(".video-upload-list",j.el).get(0),action:h+"videoUpload.action",disableDefaultDropzone:true,autoUpload:true,inputName:"video",uploadButtonText:"上传视频",cancelButtonText:"取消",failUploadText:"上传失败",allowedExtensions:["mp4"],sizeLimit:1024*50000,forceMultipart:true,customErrorTips:function(d,a){var c=d.lastChild.lastChild;c.nodeValue+=", 原因:"+a.error},onSubmit:function(){l=parseInt($(".tabs-header li.active",j.el).index(),10),k.setParams({productId:window.App.getLoadedApp().productId.getValue(),videoType:l+1})},onComplete:function(q,p,o){if(o.success){var m=h+o.filepath.substr(1),r=h+o.suolueImgUrl.substr(1),a=o.fileName,t=o.fileSize,d=$(".tabs-content:eq("+l+") ul",j.el),c=d.parent();window.App.putVideoResouce(l+1,{relativeUrl:o.filepath,suolueImgUrl:o.suolueImgUrl,fileSize:o.fileSize,videoName:o.fileName});setTimeout(function(){d.append("<li><img src='"+r+"' title='"+a+"' fileSize='"+t+"' fileName='"+a+"' videoPath='"+m+"' /></li>");$("li:last",d).trigger("click")},3000);c.scrollTop(c.offset().top)}setTimeout(function(){$(".video-upload-list",j.el).html("")},2500)},onError:function(m,c,a){}});j._loadVideoResouces()},_loadVideoResouces:function(){console.log("VideoWidget: loading video resouces.");var j=this,h=$(".tabs-header li.active",j.el),m=parseInt(h.index(),10);if(!h.data("init")){var l=window.App.getVideoResouces(m+1),k="";$.each(l,function(a,c){k+="<li><img src='"+window.App.getSitePath()+c.suolueImgUrl.substr(1)+"' title='"+c.videoName+"' fileSize='"+c.fileSize+"' fileName='"+c.videoName+"' videoPath='"+window.App.getSitePath()+c.relativeUrl.substr(1)+"' /></li>"}),$(".tabs-content:eq("+m+") ul",j.el).html("").append(k),h.data("init",!0)}}});Handlebars.registerHelper("audio_render",function(r,q){var p=new PixelSizeWidget;p.setValue(r.width),p.render();var o=new PixelSizeWidget;o.setValue(r.height),o.render();var n=new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ALIGN));n.setValue(r.align),n.render();var m=new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.DISPLAYMODE));m.setValue(r.displayMode),m.render();var l="#sub-template-widget-audio",k=Handlebars.compile($(l).html()),j=k($.extend({url:r.url,widthSetting:"<div class='fe'>"+$(".fe",p.el).html()+"</div>",heightSetting:"<div class='fe'>"+$(".fe",o.el).html()+"</div>",alignSelect:$(n.el).html(),displaySelect:$(m.el).html()},r));return j});AudioWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"audio",d),this._data={audio:c}},events:{"keydown input[type=text]":"onKeyDown","keyup input[type=text]":"onKeyPress","click .audio-width input[type=radio], .audio-height input[type=radio]":"onUnitsChanged","change .audio-align select":"onAlignChanged","change .audio-display select":"onDisplayModeChanged","click .tabs-header li:not(.active)":"onTabsClick","click .tabs-content li:not(.active)":"onAudioItemClick"},setValue:function(c){this._data.audio=c},onKeyDown:function(c){return(c.ctrlKey||c.metaKey)&&c.which==90?(window.App.undo(),!1):(c.ctrlKey||c.metaKey)&&c.which==89?(window.App.redo(),!1):!0},onKeyPress:function(c){this._changed()},onUnitsChanged:function(c){this._changed()},onAlignChanged:function(c){this._changed()},onDisplayModeChanged:function(){this._changed()},_changed:function(){this.trigger("valueChanged",{url:$(".audio-url input[type=text]",this.el).val(),fileSize:$("li.active img",this.el).attr("fileSize"),width:{value:$(".audio-width input[type=text]",this.el).val(),units:$(".audio-width input[type=radio]:checked",this.el).val()},height:{value:$(".audio-height input[type=text]",this.el).val(),units:$(".audio-height input[type=radio]:checked",this.el).val()},align:$(".audio-align select",this.el).val(),displayMode:$(".audio-display select",this.el).val()})},onTabsClick:function(h){var d=this,j=$(h.currentTarget);j.siblings().removeClass("active"),j.addClass("active"),$(".tabs-content",d.el).hide(),$(".tabs-content:eq("+j.index()+")",d.el).show().find("li").removeClass("active"),d._loadAudioResouces()},onAudioItemClick:function(h){var d=this,j=$(h.currentTarget);j.siblings().removeClass("active"),j.addClass("active"),$(".audio-url input[type=text]",d.el).val(j.find("img").attr("audioPath")),$(".fe input.ui-input-text").val(j.find("img").attr("title")).trigger("change",!0),d._changed()},onAttach:function(){var j=this,h=window.App.getSitePath(),l=null,k=new qq.FileUploader({element:$(".audio-uploader",j.el).get(0),listElement:$(".audio-upload-list",j.el).get(0),action:h+"audioUpload.action",disableDefaultDropzone:true,autoUpload:true,inputName:"audio",uploadButtonText:"上传",cancelButtonText:"取消",failUploadText:"上传失败",allowedExtensions:["mp3"],sizeLimit:1024*500000,forceMultipart:true,customErrorTips:function(d,a){var c=d.lastChild.lastChild;c.nodeValue+=", 原因:"+a.error},onSubmit:function(){l=parseInt($(".tabs-header li.active",j.el).index(),10),k.setParams({productId:window.App.getLoadedApp().productId.getValue(),audioType:l+1})},onComplete:function(q,p,o){if(o.success){var m=h+o.filepath.substr(1),r=o.fileName,d=o.fileSize,c=$(".tabs-content:eq("+l+") ul",j.el),a=c.parent();window.App.putAudioResouce(l+1,{relativeUrl:o.filepath,fileSize:o.fileSize,audioName:o.fileName}),c.append("<li><img src='images/jqm/audio_.png' title='"+r+"' fileSize='"+d+"' fileName='"+r+"' audiopath='"+m+"' /></li>"),a.scrollTop(a.offset().top),$("li:last",c).trigger("click")}setTimeout(function(){$(".audio-upload-list",j.el).html("")},2500)},onError:function(m,c,a){}});j._loadAudioResouces()},_loadAudioResouces:function(){console.log("VideoWidget: loading audio resouces.");var j=this,h=$(".tabs-header li.active",j.el),m=parseInt(h.index(),10);if(!h.data("init")){var l=window.App.getAudioResouces(m+1),k="";$.each(l,function(a,c){k+="<li><img src='images/jqm/audio_.png' title='"+c.audioName+"' fileSize='"+c.fileSize+"' fileName='"+c.audioName+"' audioPath='"+window.App.getSitePath()+c.relativeUrl.substr(1)+"' /></li>"}),$(".tabs-content:eq("+m+") ul",j.el).html("").append(k),h.data("init",!0)}}});Handlebars.registerHelper("radioitems_render",function(k,j){var q=[];for(var p=0;p<k.length;p++){var o=k[p],n="#sub-template-widget-radioitems",m=Handlebars.compile($(n).html()),l=m($.extend({},o));q.push(l)}return q.join("")});var RadioItemsWidget=ListWidget.extend({initialize:function(d,c){ListWidget.prototype.initialize.call(this,"radioitems",d),this._data={items:[]}},getItemData:function(h,c){var j=h==="add";return{text:j?"选项":$("input.text",c).val(),value:j?null:this._data.items[c.index()].value,_controlId:j?null:this._data.items[c.index()]._controlId}}});Handlebars.registerHelper("mapmarkers_render",function(k,j){var q=[];for(var p=0;p<k.length;p++){var o=k[p],n="#sub-template-widget-mapmarkers",m=Handlebars.compile($(n).html()),l=m($.extend({},o));q.push(l)}return q.join("")});var MapMarkerWidget=ListWidget.extend({initialize:function(c){ListWidget.prototype.initialize.call(this,"mapmarker",c)},getItemData:function(h,c){var j=h==="add";return{text:$("input.location",c).val()||"",location:$("input.location",c).val()||""}},onItemChanged:function(d){var c=this;clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){ListWidget.prototype.onItemChanged.call(c,d)},1000)}});Handlebars.registerHelper("tablecolumns_render",function(v,u){var t=[],h=$("select:first",window.App.getPropertyView().el).val(),m=window.App.getColumnsForDataTable(h);for(var s=0;s<v.length;s++){var r=v[s],q=new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],m));q.setValue(r.columnValue),q.render();var l="#sub-template-widget-tablecolumns",k=Handlebars.compile($(l).html()),j=k($.extend({columnSelect:$(q.el).html()},r));t.push(j)}return t.join("")});var TableColumnsWidget=ListWidget.extend({initialize:function(c){ListWidget.prototype.initialize.call(this,"tablecolumns",c)},getItemData:function(h,c){var m=h==="add",l=$("#userview-property select:first").val(),k=window.App.getDefaultColumnForDataTable(l),j=$("select > option:selected",c);return{text:"列 - "+(m?k.text:j.text()),columnValue:m?k.value:j.attr("value"),columnText:m?k.text:j.text(),priority:1}}}),FontStyleWidget=Widget.extend({initialize:function(c){Widget.prototype.initialize.call(this,"fontstyle",c)},events:{"click a.font-weight, a.font-style, a.text-decoration":"onFontStyleClicked","mouseenter a.font-color":"onFontColorMouseenter","mouseleave a.font-color":"onFontColorMouseleave"},onFontStyleClicked:function(d){var c=$(d.currentTarget);c.toggleClass("selected"),this._valueChanged()},onFontColorMouseenter:function(n){var r=$(n.currentTarget),q=$("#font-color-menu"),p=SETTINGS.FONTCOLOR,o=p.length,n='<a href="javascript:;" title="$color" style="background-color: $color"></a>',m="",l=r.offset(),k=this;if(q.length<1){q=$('<div id="font-color-menu" class="font-color-menu" />').appendTo($("body")),q.delegate("a","click",function(t){var s=$(t.currentTarget),h=s.attr("title"),v=$(this).parent(),u=v.data("widget");v.hide(),u.$("a.font-color .color-preview").attr("val",h).css("background-color",h),u._valueChanged()}).bind("mouseleave",function(){$(this).hide()});for(var j=0;j<o;j++){m+=n.replace(/\$color/g,p[j])}q.append(m)}q.css({top:l.top+22,left:l.left}).data("widget",this).show()},onFontColorMouseleave:function(d){var c=$("#font-color-menu");if(!Utils.containsPoint(d,c)){c.hide()}},_valueChanged:function(){var j=this.$("a.font-weight"),h=this.$("a.font-style"),l=this.$("a.font-color"),k=this.$("a.text-decoration");this.trigger("valueChanged",{fontWeight:j.hasClass("selected")?"bold":"normal",fontStyle:h.hasClass("selected")?"italic":"normal",fontColor:$(".color-preview",l).attr("val"),textDecoration:k.hasClass("selected")?"underline":"none"})}}),MarginSettingsWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"marginsettings",d),this._delay=c||500},events:{"keyup input":"onKeyPress","keydown input":"onKeyDown"},onKeyPress:function(d){var c=this;this._delay?(clearTimeout(this._delayTimeout),this._delayTimeout=setTimeout(function(){c.trigger("valueChanged",h())},this._delay)):this.trigger("valueChanged",h());function h(){return{top:c.$("input[name=top]").val(),right:c.$("input[name=right]").val(),bottom:c.$("input[name=bottom]").val(),left:c.$("input[name=left]").val(),inline:c._data.inline}}},onKeyDown:function(c){return(c.ctrlKey||c.metaKey)&&c.which==90?(window.App.undo(),!1):(c.ctrlKey||c.metaKey)&&c.which==89?(window.App.redo(),!1):!0}}),HtmlSourceWidget=Widget.extend({initialize:function(d,c){Widget.prototype.initialize.call(this,"htmlsource",d),this._delay=c||500},events:{"keyup textarea":"onKeyPress","keydown textarea":"onKeyDown"},onKeyPress:function(){var a=this;this._delay?(clearTimeout(this._delayTimeout),this._delayTimeout=setTimeout(function(){a.trigger("valueChanged",a.$("textarea").val())},this._delay)):this.trigger("valueChanged",a.$("textarea").val())},onKeyDown:function(c){return(c.ctrlKey||c.metaKey)&&c.which==90?(window.App.undo(),!1):(c.ctrlKey||c.metaKey)&&c.which==89?(window.App.redo(),!1):!0},setValue:function(c){this._data.htmlsource=this._decode(c)},_encode:function(c){var a="";if(!c||c.length===0){return""}a=c.replace(/&/g,"&gt;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;").replace(/\'/g,"&#39;").replace(/\"/g,"&quot;").replace(/\n/g,"<br>");return a},_decode:function(c){var a="";if(!c||c.length===0){return""}a=c.replace(/&gt;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&nbsp;/g," ").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/<br>/g,"\n");return a}});Property=Backbone.View.extend({initialize:function(h,d,j){this._title=h,this.value=j,this._widget=d,d.setValue(this.value),this._defaultData={value:this.value,_property_title:h}},setValue:function(h,c){if(c&&$.isArray(this.value)){var j=this.value.length,d=h.length;j>d&&this.trigger("itemDeleted",this.value[j-1]),d>j&&this.trigger("itemAdded",h[d-1])}this.value=h,this._widget.setValue(h)},updateValue:function(c){this.value=c,this._widget.updateValue(c)},getDefaultValue:function(){return this._defaultData.value},getValue:function(){return this.value},serialize:function(){var c=this._serializeProperty(this.value);return c},_serializeProperty:function(j){if(typeof j=="object"){var h={};for(var l in j){var k=j[l];h[l]=this._serializeProperty(k)}return h}return j},render:function(){this.renderWidget()},renderWidget:function(){this._widget.render(this._defaultData._property_title)},getRenderedWidget:function(){return this._widget.el},bindWidgetEvent:function(d,c){this._widget.bind(d,c,this)},getName:function(){return this._title},setName:function(c){this._title=c,this._defaultData._property_title=c},getWidget:function(){return this._widget},handle:function(c){}});_.extend(Property,Backbone.Events);ScalarProperty=Property.extend({initialize:function(j,h,l){Property.prototype.initialize.call(this,j,h,l);var k=this;this.bindWidgetEvent("valueChanged",function(d){console.log("PROPERTY: value changed ",k.getName(),k.getValue(),d);var c=k.getValue();if(c==d){return}k.updateValue(d),k.trigger("valueChanged",d),k.trigger("propertyChanged",k,c,d)})}});_.extend(ScalarProperty,Backbone.Events);ArrayProperty=Property.extend({initialize:function(j,h,l){Property.prototype.initialize.call(this,j,h,l);var k=this;this.bindWidgetEvent("itemAdded",function(m){var d=k.getValue().slice(0);k.addItem(m);var n=k.getValue().slice(0);k.trigger("itemAdded",m),k.trigger("propertyChanged",k,d,n,!0)}),this.bindWidgetEvent("itemChanged",function(m,d){console.log("PROPERTY: itemChanged",m,d);var p=k.getValue().slice(0),o=k.replaceItem(m,d),n=k.getValue().slice(0);k.trigger("itemChanged",d,o),k.trigger("propertyChanged",k,p,n)}),this.bindWidgetEvent("itemDeleted",function(m){var d=k.getValue().slice(0),o=k.removeItem(m),n=k.getValue().slice(0);k.trigger("itemDeleted",o),k.trigger("propertyChanged",k,d,n,!0)}),this.bindWidgetEvent("itemMoved",function(m,d){var o=k.getValue().slice(0);k.moveItem(m,d);var n=k.getValue().slice(0);k.trigger("itemMoved",m,d),k.trigger("propertyChanged",k,o,n)})},addItem:function(c){$.isArray(this.value)&&this.value.push(c)},removeItem:function(d){if($.isArray(this.value)&&d<this.value.length){var c=this.value[d];return this.value.splice(d,1),c}return null},moveItem:function(h,d){if($.isArray(this.value)&&h<this.value.length&&d<this.value.length){var j=this.value[h];this.value.splice(h,1),this.value.splice(d,0,j)}},replaceItem:function(h,d){if($.isArray(this.value)&&h<this.value.length){var j=this.value[h];return this.value[h]=d,j}return null},size:function(){return this.value.length}});Control=Backbone.View.extend({initialize:function(h,d,j){this._id=null,this._name=SETTINGS.CONTROLNAMES[h],this.controlType=h,this._template=d,this.children=[],this.childrenLookup={},this.namedChildren={},this.appendSelector=":first",this._propertiesMap={},this._appendMode=SETTINGS.ControlAppendMode.CONTENT_APPEND,this._alreadyAfterBound=!1,this._layout=new BoxLayout(this),this._isContainer=!1,this._supportsSorting=!1,this._supportsChildRendering=!0,this._canDelete=!0,this._sortableItemsSelector="> [data-cid]",this._dropShim='<div class="shim"></div>',this._dropShimSelector=".shim",this._initDefaultProperties(j)},render:function(j){console.log("CONTROL: rendering ",this.getId());var q=this._getRenderData(),p="#template-control-"+this._template,o=Handlebars.compile($(p).html()),n=o(q),m=j.createElement("div"),l,k;$(m).html(n),m.children.length>0&&(l=$(m).children(),k=$(l.get(0)).attr("data-cid",this._id).addClass("cfwx-control"),this._isContainer&&k.addClass("cfwx-container"),this.getControlType()=="page"&&this._deviceRenderedEl?this._deviceRenderedEl.empty():this._deviceRenderedEl=l,this._layout.render(j),this._layout.el.children.length>0&&this.positionLayoutElement(this._deviceRenderedEl,this._layout.el),this.trigger("controlRendered")),this.el=m},getId:function(){return this._id},setId:function(c){this._id=c},getName:function(){return this._name},getChild:function(c){return c>=this.children.length||c<0?null:this.children[c]},setParent:function(c){this.parentControl=c},getParent:function(){return this.parentControl},setAppendMode:function(c){this._appendMode=c},getAppendMode:function(){return this._appendMode},isContainer:function(){return this._isContainer},setIsContainer:function(c){this._isContainer=c},supportsSorting:function(){return this._supportsSorting},setSupportsSorting:function(c){this._supportsSorting=c},getLayout:function(){return this._layout},setLayout:function(c){this._layout=c},setSortableItemsSelector:function(c){this._sortableItemsSelector=c},getSortableItemsSelector:function(){return this._sortableItemsSelector},getControlType:function(){return this.controlType},getPropertiesSorted:function(){return this._sortProperties()},isValidNode:function(){var h=this,d=this.controlType,j=(this.parentControl?this.parentControl.controlType:"");return(d=="heading"?!(j=="pageheader"||j=="pagefooter"):!0)&&!{pagecontent:1,collapsiblecontent:1,radio:1,checkbox:1,gridblock:1}.hasOwnProperty(d)},_getRenderData:function(){var c={__control:this,__children:this.children,__namedChildren:this.namedChildren};return $.extend(c,this._propertiesMap),c},_initDefaultProperties:function(d){var c=window.Utils?this._name+Utils.IdGiver.give(this.controlType):this._name;d||this.isValidNode()&&(this.title=new ScalarProperty("控件名称",new SingleTextWidget(new AcceptAllInputFilter),c),this.addProperty("title",this.title,{pos:-2}),this.margin=new ScalarProperty("边距",new MarginSettingsWidget(null),{top:"",right:"",bottom:"",left:"",inline:false}),this.addProperty("margin",this.margin,{pos:-1}))},addProperty:function(j,h,l){this._propertiesMap[j]={},$.extend(this._propertiesMap[j],{property:h},l);var k=this;h.bind("propertyChanged",function(m,d,o,n){k.onPropertyChanged(m,d,o,n)})},getProperties:function(){return this._propertiesMap},getSerializedProperties:function(){var h={};for(var d in this._propertiesMap){var j=this._propertiesMap[d].property;h[d]=j.getValue()}return h},initFromSerialized:function(c){this.setId(c.id),this.initFromSerializedProperties(c.properties)},initFromSerializedProperties:function(h){if(!h){return}for(var d in h){var j=this._propertiesMap[d];j&&j.property.setValue(h[d])}},onAfterBind:function(){},setAlreadyAfterBound:function(c){this._alreadyAfterBound=c},hasAlreadyAfterBound:function(){return this._alreadyAfterBound},_getRandomNumber:function(){return parseInt(Math.random()*1000000+1,10)},_initChildControl:function(c){if(!c.getId()){c.setId(c.controlType+this._getRandomNumber()),console.log("CONTROL: new %s control added with id %s",c.getControlType(),c.getId())}else{console.log("CONTROL: added existing child with id ",c.getId())}return c.getId()===this.getId()?(console.error("CONTROL: attempt to add child to itself"),!1):!0},addChildAtPoint:function(d,c){this.addChild(d)},addChild:function(c){console.log("CONTROL: addChild",c,this);if(!this._initChildControl(c)){return}c.parentControl=this,this.children.push(c),this.childrenLookup[c.getId()]=c,this.trigger("childAdded",c)},insertChild:function(d,c){console.log("CONTROL: insertChild",d,c);if(!this._initChildControl(d)){return}d.parentControl=this,this.children.splice(c,0,d),this.childrenLookup[d.getId()]=d,this.trigger("childAdded",d,c)},removeChild:function(j){var h=-1,m=null;for(var l=0;l<this.children.length;l++){var k=this.children[l];if(k.getId()===j.getId()){k.parentControl=null,m=k,h=l;break}}return h<0?(console.error("CONTROL: couldn't find child to remove!"),m):(console.log("CONTROL: Removed child with id: "+j.getId()),this.children.splice(h,1),delete this.childrenLookup[j.getId()],this.trigger("childRemoved",j),m)},removeControlAtIndex:function(d){if(d>this.children.length||d<0){return}var c=this.children[d];return c.parentControl=null,this.children.splice(d,1),delete this.childrenLookup[c.getId()],this.trigger("childRemoved",c),c},moveChild:function(j,h){var m=-1;for(var l=0;l<this.children.length;l++){var k=this.children[l];if(k.getId()===j.getId()){m=l;break}}return m<0?-1:(this.children.splice(l,1),this.children.splice(h,0,j),h)},getChildren:function(){return this.children},getChildWithId:function(h){for(var d=0;d<this.children.length;d++){var j=this.children[d];if(j.getId()===h){return j}}return null},getDeviceRenderedEl:function(){return this._deviceRenderedEl},setDeviceRenderedEl:function(c){this._deviceRenderedEl=c},positionLayoutElement:function(d,c){d.append($(c).contents())},_sortProperties:function(){var h=[];for(var d in this._propertiesMap){h.push($.extend({propertyName:d},this._propertiesMap[d]))}var j=h.sort(function(k,c){if(k.pos>c.pos){return 1}if(k.pos===c.pos){return 0}if(k.pos<c.pos){return -1}});return j},onDragOver:function(d,c){},onDragPosition:function(c){this.parent&&this.parent.onDragPosition(c)},onDragDrop:function(c){},onDragOut:function(){var c=this.getDeviceRenderedEl().get(0);$(this._dropShimSelector,c).remove()},onDropFinished:function(){$(this._dropShimSelector,this.getDeviceRenderedEl()).remove()},containsPoint:function(j){var h=$(this.getDeviceRenderedEl()),n=h.offset(),m=h.outerWidth(),l=h.outerHeight(),k=this.getCalculatedMargin();if(k[3]<0&&k[1]<0){if(j.x>n.left+m+-k[1]||j.x<n.left+k[3]||j.y>n.top+l||j.y<n.top){return !1}}else{if(j.x>n.left+m||j.x<n.left||j.y>n.top+l||j.y<n.top){return !1}}return !0},isPointAfterMidway:function(j){var h=$(this.getDeviceRenderedEl()),m=h.offset(),l=h.outerWidth(),k=h.outerHeight();return j.y>=m.top+k/2&&j.y<=m.top+k},getCalculatedWidth:function(){var c=this._deviceRenderedEl;return c?$(c).outerWidth():0},getCalculatedMargin:function(){var r=this._deviceRenderedEl;if(r){var q=parseInt($(r).css("marginLeft"),10),p=parseInt($(r).css("paddingLeft"),10),o=parseInt($(r).css("marginTop"),10),n=parseInt($(r).css("paddingTop"),10),m=parseInt($(r).css("marginRight"),10),l=parseInt($(r).css("paddingRight"),10),k=parseInt($(r).css("marginBottom"),10),j=parseInt($(r).css("paddingBottom"),10);return[o+n,m+l,k+j,q+p]}return[0,0,0,0]},acceptControl:function(c){return !0},onPropertyChanged:function(j,h,l,k){console.log("CONTROL: property changed: ",this.getId(),j.getName(),h,l,k);this.trigger("propertyChanged",j,h,l),this.trigger("controlUpdated",this,k)},getDeviceExistingControl:function(c){return c('[data-cid="'+this._id+'"]')},cloneControl:function(r){console.log("CONTROL: clone control",this);var q=ControlFactory.newControl(this.controlType);r&&q.setId(this.getId());var p=q.getProperties();for(var o in this._propertiesMap){var n=this._propertiesMap[o].property,m=p[o];if(!m){console.error("Cloning control no property with name",o);continue}$.isArray(n.getValue())?m.property.setValue($.extend(!0,[],n.getValue())):typeof n.getValue()=="object"?m.property.setValue($.extend(!0,{},n.getValue())):m.property.setValue(n.getValue())}for(var l=0;l<this.children.length;l++){var k=this.children[l],j=k.cloneControl(r);j.setId(j.controlType+this._getRandomNumber()),j.parentControl=q,q.children.push(j),q.childrenLookup[j.getId()]=j}return q},quickRenderTo:function(d){if(!(this instanceof AppControl)){return}var c=document.createElement("div");this._layout.renderTo(c),$(d).append($(c).contents())},renderTo:function(j){var h=this._getRenderData(),n="#template-control-"+this._template,m=Handlebars.compile($(n).html()),l=m(h);$(j).html(l);var k=document.createElement("div");this._layout.renderTo(k),$(":first",j).append($(k).contents())}}),AppControl=Control.extend({initialize:function(){Control.prototype.initialize.call(this,"app","app"),this.name=new ScalarProperty("模板名称",new NullWidget(),""),this.remark=new ScalarProperty("备注",new NullWidget(),""),this.businessFlag=new ScalarProperty("业务标识",new NullWidget(),""),this.businessName=new ScalarProperty("业务名称",new NullWidget(),""),this.addProperty("name",this.name,{pos:1}),this.addProperty("remark",this.remark,{pos:1}),this.addProperty("businessFlag",this.businessFlag,{pos:1}),this.addProperty("businessName",this.businessName,{pos:1})}}),PageControl=Control.extend({initialize:function(){var a=this;Control.prototype.initialize.call(this,"page","page"),this.margin._widget=new NullWidget(),this.title.setName("页面名称"),this.setIsContainer(!0),this.setSupportsSorting(!1),this.nodes=[],this.theme=new ScalarProperty("主题",new ThemeSelectorWidget(new AcceptAllInputFilter,!1),""),this.contentPadding=new ScalarProperty("内边距",new MarginSettingsWidget(),{top:10,right:10,bottom:10,left:10}),this.addProperty("theme",this.theme,{pos:1}),this.addProperty("contentPadding",this.contentPadding,{pos:2})},addChildAtPoint:function(d,c){d.getControlType()==="pageheader"?this.insertChild(d,0):d.getControlType()=="pagefooter"||d.getControlType()=="tabbar"?this.addChild(d):Control.prototype.addChildAtPoint.call(this,d,c)},addNode:function(c){c.isValidNode()&&this.nodes.push(c);for(var d=0;d<c.children.length;d++){this.addNode(c.children[d])}},removeNode:function(c){for(var d=0;d<this.nodes.length;d++){var h=this.nodes[d];if(h.getId()===c.getId()){h.parentControl=null,this.nodes.splice(d,1);break}}},initTreeNodes:function(){console.log("CONTROL: init page nodes",this.getId());this.nodes=[];for(var a=0;a<this.children.length;a++){this.addNode(this.children[a])}}}),PageContentControl=Control.extend({initialize:function(){Control.prototype.initialize.call(this,"pagecontent","pagecontent"),this.setIsContainer(!0),this.setSupportsSorting(!0)},acceptControl:function(c){return c.getControlType()!="pageheader"&&c.getControlType()!="pagefooter"&&c.getControlType()!="tabbar"},onDragOut:function(){var c=this.getDeviceRenderedEl().get(0);$(this._dropShimSelector,c).remove()},onDragOver:function(y,x){var v=ControlFactory.getControlForType(x);if(!v){return}var u=v.defaultSize,t=this.getDeviceRenderedEl().get(0);$(this._dropShimSelector,t).remove();var s=t.children,r=null,q=$(this._dropShim);v&&u&&q.css({width:u[0],height:u[1]});if(s.length<=0){$(t).append(q);return}for(var p=0;p<t.children.length;p++){var v=t.children[p],o=v.offsetLeft,n=v.offsetTop;if(!(p+1<t.children.length)){if(n<y.y){$(q).insertAfter(v);return}$(q).insertBefore(v);return}var m=t.children[p+1];if(y.y>n&&y.y<m.offsetTop){$(q).insertAfter(v);return}if(y.y<n){$(q).insertBefore(v);return}}},onDragPosition:function(j){var h=$("> .cfwx-control",this.getDeviceRenderedEl());$(this._dropShimSelector,h).remove();var m=h.children(),l=null;if(m.length<=0||j+1>=m.length||j==0){$(h).append(this._dropShim);return}var k=m[j+1];$(this._dropShim).insertAfter(k)},addChildAtPoint:function(j,h){if(this.children.length<1||!h){Control.prototype.addChildAtPoint.call(this,j,h);return}for(var m=0;m<this.children.length;m++){var l=this.children[m],k=l.getDeviceRenderedEl().get(0);if(k.offsetTop>h.y){this.insertChild(j,m);return}}Control.prototype.addChildAtPoint.call(this,j,h)},getIndexAtPoint:function(j){if(this.children.length<1||!j){return 0}for(var h=0;h<this.children.length;h++){var l=this.children[h],k=l.getDeviceRenderedEl().get(0);if(k.offsetTop<j.y){return h}}return 0}}),PageHeaderControl=Control.extend({initialize:function(d,c){Control.prototype.initialize.call(this,d||"pageheader",c||"pageheader");var d=this;this.margin._widget=new NullWidget(),this.setIsContainer(!0),this.setSupportsSorting(!0),this.theme=new ScalarProperty("主题",new ThemeSelectorWidget(new AcceptAllInputFilter),"a"),this.isFixed=new ScalarProperty("固定位置",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ISFIXED)),""),this.noHeading=new ScalarProperty("No Heading",new NullWidget,"false"),this.addProperty("theme",this.theme,{pos:1}),this.addProperty("isFixed",this.isFixed,{pos:2}),this.addProperty("noHeading",this.noHeading,{pos:3}),this.bind("childRemoved",function(a){d.noHeading.setValue(d.children.length?"false":"true"),d.trigger("controlUpdated",d,!1)}),this.bind("childAdded",function(a){d.noHeading.setValue("false"),d.trigger("controlUpdated",d,!1)})},onDragOver:function(C,B){var A=ControlFactory.getControlForType(B);if(!A){return}var z=A.defaultSize,y=this._deviceRenderedEl.get(0);$(this._dropShimSelector,y).remove();var x=y.children,v=null,u=this._deviceRenderedEl.width(),t=this._deviceRenderedEl.height(),s=$(this._dropShim);A&&z&&(B==="button"?s.css({width:63,height:28}):s.css({width:z[0],height:z[1]})),B==="button"&&C.y<t-5&&(C.x<u/2?(console.log("CONTROL: drag to left of header"),s.removeClass("ui-btn-right").addClass("ui-btn ui-btn-left")):(console.log("CONTROL: drag to right of header"),s.removeClass("ui-btn-left").addClass("ui-btn ui-btn-right")));if(x.length<=0){$(y).append(s);return}for(var r=0;r<y.children.length;r++){var A=y.children[r],q=A.offsetLeft,p=A.offsetTop;if(!(r+1<y.children.length)){if(p<C.y){$(s).insertAfter(A);return}$(s).insertBefore(A);return}var o=y.children[r+1];if(C.y>p&&C.y<o.offsetTop){$(s).insertAfter(A);return}if(C.y<p){$(s).insertBefore(A);return}}},addChildAtPoint:function(j,h){if(this._deviceRenderedEl&&h){var o=this._deviceRenderedEl.width(),n=this._deviceRenderedEl.height();j.controlType=="button"&&h.y<n-5&&(h.x<o/2?j.extraClasses.setValue("ui-btn-left"):j.extraClasses.setValue("ui-btn-right"))}if(this.children.length<1||!h){Control.prototype.addChildAtPoint.call(this,j,h);return}for(var m=0;m<this.children.length;m++){var l=this.children[m],k=l.getDeviceRenderedEl().get(0);if(k.offsetTop>h.y){this.insertChild(j,m);return}}Control.prototype.addChildAtPoint.call(this,j,h)},getIndexAtPoint:function(j){if(this.children.length<1||!j){return 0}for(var h=0;h<this.children.length;h++){var l=this.children[h],k=l.getDeviceRenderedEl().get(0);if(k.offsetTop<j.y){return h}}return 0},onAfterBind:function(){var c=new HeadingControl(!0);c.text.setValue("页头"),c.size.setValue(3),this.addChild(c)}},{defaultSize:["100%",39]}),PageFooterControl=PageHeaderControl.extend({initialize:function(){PageHeaderControl.prototype.initialize.call(this,"pagefooter","pagefooter"),this.isFixed.setValue("fixed")},onAfterBind:function(){var c=new HeadingControl(!0);c.text.setValue("页脚"),c.size.setValue(3),this.addChild(c)}},{defaultSize:["100%",39]}),HeadingControl=Control.extend({initialize:function(k){var j=this;Control.prototype.initialize.call(this,"heading","heading",k);var h=2,l="标题";this.text=new ScalarProperty("文本",new SingleTextWidget(new AcceptAllInputFilter),l);this.size=new ScalarProperty("尺寸",k?new NullWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.SIZE)):new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.SIZE)),h),this.addProperty("text",this.text,{pos:0}),this.addProperty("size",this.size,{pos:1})}},{defaultSize:["100%",24]}),NavBarControl=Control.extend({initialize:function(){Control.prototype.initialize.call(this,"navbar","navbar");var a=[{text:"按钮",url:window.App?"#"+window.App.getCurrentPage().getId():"",icon:"arrow-u",theme:"",isActive:!1}];this.iconPos=new ScalarProperty("图标位置",new IconSelectWidget(IconSelectWidget.ALIGN_ONLY),{align:"top"}),this.items=new ArrayProperty("元素集合",new ButtonListItemWidget(new AcceptAllInputFilter),a),this.addProperty("iconPos",this.iconPos,{pos:1}),this.addProperty("items",this.items,{pos:2})}},{defaultSize:["100%",36]}),ListViewControl=Control.extend({initialize:function(){var c=this;Control.prototype.initialize.call(this,"listview","listview"),this.dividerTheme=new ScalarProperty("主题",new ThemeSelectorWidget(new AcceptAllInputFilter),"b"),this.displayInset=new ScalarProperty("嵌入",new NullWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.DISPLAYINSET)),"true"),this.items=new ArrayProperty("元素集合",new ListViewItemsWidget(new AcceptAllInputFilter),[]),this.addProperty("dividerTheme",this.dividerTheme,{pos:1}),this.addProperty("displayInset",this.displayInset,{pos:2}),this.addProperty("items",this.items,{pos:3}),this.items.setValue([{text:"分栏",isDivider:!0},{text:"按钮",isDivider:!1,transition:"slide",theme:"c",url:window.App?"#"+window.App.getCurrentPage().getId():""}])}},{defaultSize:["100%",74]}),CollapsibleSetControl=Control.extend({initialize:function(){var c=this;Control.prototype.initialize.call(this,"collapsible","collapsible"),this.setIsContainer(!0),this.setSupportsSorting(!1),this.setSortableItemsSelector("> .ui-collapsible-content > [data-cid], > .ui-collapsible > .ui-collapsible-content > [data-cid]");this.headerTheme=new ScalarProperty("主题",new ThemeSelectorWidget(new AcceptAllInputFilter),""),this.contentTheme=new ScalarProperty("内容主题",new ThemeSelectorWidget(new AcceptAllInputFilter),""),this.sections=new ArrayProperty("元素集合",new AccordionSectionItemWidget(new AcceptAllInputFilter),[]),this.addProperty("sections",this.sections,{pos:2}),this.addProperty("headerTheme",this.headerTheme,{pos:0}),this.addProperty("contentTheme",this.contentTheme,{pos:1}),this.sections.bind("itemAdded",function(a){var d=new CollapsibleContentControl;d.headerText.setValue(a.text),d.isCollapsed.setValue(a.isCollapsed),c.addChild(d),a._controlId=d.getId()}),this.sections.bind("itemChanged",function(a,k){var j=a._controlId,h=c.getChildWithId(j);console.log("CONTROL: changed collapsible with id",j);if(!h){return}h.headerText.setValue(a.text),h.isCollapsed.setValue(a.isCollapsed)}),this.sections.bind("itemDeleted",function(a){var j=a._controlId,h=c.getChildWithId(j);console.log("CONTROL: changed collapsible with id",j);if(!h){return}c.removeChild(h)}),this.sections.bind("itemMoved",function(a,j){var h=c.getChild(j);h&&c.moveChild(h,a)}),this.sections.setValue([{text:"标题",isCollapsed:!1}])},onAfterBind:function(){var c=new CollapsibleContentControl;this.addChild(c),this.sections.getWidget()._data.items[0]._controlId=c.getId()},getCalculatedWidth:function(){var c=$("h3:first").outerWidth(!0);return c},getCalculatedMargin:function(){var j=$("h3:first",this._deviceRenderedEl);if(j){var h=parseInt($(j).css("marginLeft")),m=parseInt($(j).css("marginTop")),l=parseInt($(j).css("marginRight")),k=parseInt($(j).css("marginBottom"));return[m,l,k,h]}return[0,0,0,0]},cloneControl:function(r){console.log("CONTROL: clone control",this);var q=ControlFactory.newControl(this.controlType);r&&q.setId(this.getId());var p=q.getProperties();for(var o in this._propertiesMap){var n=this._propertiesMap[o].property,m=p[o];if(!m){console.error("Cloning control no property with name",o);continue}$.isArray(n.getValue())?m.property.setValue($.extend(!0,[],n.getValue())):typeof n.getValue()=="object"?m.property.setValue($.extend(!0,{},n.getValue())):m.property.setValue(n.getValue())}for(var l=0;l<this.children.length;l++){var k=this.children[l],j=k.cloneControl(r);j.setId(j.controlType+this._getRandomNumber()),j.parentControl=q,q.children.push(j),q.childrenLookup[j.getId()]=j,q.sections.getWidget()._data.items[l]._controlId=j.getId()}return q},onDragOver:function(d,c){},addChildAtPoint:function(j,h){if(this.sections.size()<2||!h){if(this.children.length<1||!h){Control.prototype.addChildAtPoint.call(this,j,h);return}for(var m=0;m<this.children.length;m++){var l=this.children[m],k=l.getDeviceRenderedEl().get(0);if(k.offsetTop>h.y){this.insertChild(j,m);return}}}Control.prototype.addChildAtPoint.call(this,j,h)},getIndexAtPoint:function(j){if(this.children.length<1||!j){return 0}for(var h=0;h<this.children.length;h++){var l=this.children[h],k=l.getDeviceRenderedEl().get(0);if(k.offsetTop<j.y){return h}}return 0}},{defaultSize:["100%",60]}),CollapsibleContentControl=Control.extend({initialize:function(){Control.prototype.initialize.call(this,"collapsiblecontent","collapsiblecontent"),this.setIsContainer(!0),this.setSupportsSorting(!0),this.setSortableItemsSelector("> .ui-collapsible-content > [data-cid]"),this.headerText=new ScalarProperty("Header Text",new NullWidget,"标题"),this.isCollapsed=new ScalarProperty("Is Collapsed",new NullWidget,!1),this.addProperty("headerText",this.headerText,{pos:0}),this.addProperty("isCollapsed",this.isCollapsed,{pos:1})},onDragOver:function(y,x){var v=ControlFactory.getControlForType(x);if(!v){return}var u=v.defaultSize,t=$(this.getDeviceRenderedEl()).children().get(1);$(this._dropShimSelector,t).remove();var s=t.children,r=null,q=$(this._dropShim);v&&u&&q.css({width:u[0],height:u[1]});if(s.length<=0){$(t).append(q);return}for(var p=0;p<t.children.length;p++){var v=t.children[p],o=v.offsetLeft,n=v.offsetTop;if(!(p+1<t.children.length)){if(n<y.y){$(q).insertAfter(v);return}$(q).insertBefore(v);return}var m=t.children[p+1];if(y.y>n&&y.y<m.offsetTop){$(q).insertAfter(v);return}if(y.y<n){$(q).insertBefore(v);return}}!(y.x<w/2)},addChildAtPoint:function(j,h){if(this.children.length<1||!h){Control.prototype.addChildAtPoint.call(this,j,h);return}for(var m=0;m<this.children.length;m++){var l=this.children[m],k=l.getDeviceRenderedEl().get(0);if(k.offsetTop>h.y){this.insertChild(j,m);return}}Control.prototype.addChildAtPoint.call(this,j,h)}}),TextBlockControl=Control.extend({initialize:function(){var d=this,c="<b>在这里输入内容...</b>";Control.prototype.initialize.call(this,"text","textblock");this.margin._widget=new NullWidget(),this.text=new ScalarProperty("Text",new TextEditorWidget(new AcceptAllInputFilter),c),this.addProperty("text",this.text,{pos:1})}},{defaultSize:["100%",24]}),Handlebars.registerHelper("gridclass",function(h,d){var j={2:"a",3:"b",4:"c",5:"d"};return j[h]}),GridControl=Control.extend({initialize:function(){var c=this;Control.prototype.initialize.call(this,"grid","grid"),this.setLayout(new GridLayout(this)),this.setIsContainer(!0),this.setSupportsSorting(!1),this.columns=new ScalarProperty("列",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.COLUMNS)),"2"),this.rows=new ScalarProperty("行",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ROWS)),"1"),this.addProperty("columns",this.columns,{pos:0}),this.addProperty("rows",this.rows,{pos:1});var c=this;this.bind("propertyChanged",function(a,l,k){var j=parseInt(c.rows.getValue()),h=parseInt(c.columns.getValue());c._resize(j,h)})},onAfterBind:function(){var d=new GridBlockControl;this.addChild(d);var c=new GridBlockControl;this.addChild(c),this._gridList=[[d,c]],this._resize(parseInt(this.rows.getValue()),parseInt(this.columns.getValue()))},_resize:function(j,h){var l,k;for(l=0;l<j*h;l++){k=this.getChild(l),k||(k=new GridBlockControl,this.insertChild(k,l))}while(this.children.length>j*h){this.removeControlAtIndex(j*h)}},getGrid:function(){return this._gridList}},{defaultSize:["100%",60]}),GridBlockControl=Control.extend({initialize:function(){var c=this;Control.prototype.initialize.call(this,"gridblock","gridblock"),this.setIsContainer(!0),this.setSupportsSorting(!0),this.columnIndex=new ScalarProperty("Index",new SingleTextWidget(new AcceptUrlInputFilter),"a"),this.addProperty("columnIndex",this.columnIndex,{pos:0})},onDragOver:function(y,x){var v=ControlFactory.getControlForType(x);if(!v){return}var u=v.defaultSize,t=$(this.getDeviceRenderedEl()).get(0);$(this._dropShimSelector,t).remove();var s=t.children,r=null,q=$(this._dropShim);v&&u&&q.css({width:u[0],height:u[1]});if(s.length<=0){$(t).append(q);return}for(var p=0;p<t.children.length;p++){var v=t.children[p],o=v.offsetLeft,n=v.offsetTop;if(!(p+1<t.children.length)){if(n<y.y){$(q).insertAfter(v);return}$(q).insertBefore(v);return}var m=t.children[p+1];if(y.y>n&&y.y<m.offsetTop){$(q).insertAfter(v);return}if(y.y<n){$(q).insertBefore(v);return}}!(y.x<w/2)},addChildAtPoint:function(j,h){if(this.children.length<1||!h){Control.prototype.addChildAtPoint.call(this,j,h);return}for(var m=0;m<this.children.length;m++){var l=this.children[m],k=l.getDeviceRenderedEl().get(0);if(k.offsetTop>h.y){this.insertChild(j,m);return}}Control.prototype.addChildAtPoint.call(this,j,h)}},{defaultSize:[60,60]}),LinkControl=Control.extend({initialize:function(){var h=this;Control.prototype.initialize.call(this,"link","link");var d="文字链接",j="fade";this.text=new ScalarProperty("文本",new SingleTextWidget(new AcceptAllInputFilter),d),this.url=new ScalarProperty("链接到",new UrlOrPageSelectWidget(new AcceptAllInputFilter),""),this.openNewWindow=new ScalarProperty("新窗口打开",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.OPENNEWWINDOW)),"false"),this.fontFamily=new ScalarProperty("字体",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.FONTFAMILY))),this.fontSize=new ScalarProperty("字体大小",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.FONTSIZE)),"medium"),this.fontStyle=new ScalarProperty("字体样式",new FontStyleWidget(new AcceptAllInputFilter),{fontStyle:"normal",fontWeight:"normal",fontColor:"#2489CE",textDecoration:"underline"}),this.url.setValue(window.App?"#"+window.App.getCurrentPage().getId():""),this.addProperty("text",this.text,{pos:0}),this.addProperty("url",this.url,{pos:1}),this.addProperty("openNewWindow",this.openNewWindow,{pos:2}),this.addProperty("fontFamily",this.fontFamily,{pos:4}),this.addProperty("fontSize",this.fontSize,{pos:5}),this.addProperty("fontStyle",this.fontStyle,{pos:6})}},{defaultSize:["100%",24]}),ButtonControl=Control.extend({initialize:function(){Control.prototype.initialize.call(this,"button","button");var k=this,j="按钮",p="false",o=window.App?"#"+window.App.getCurrentPage().getId():"",n="",m={icon:"",align:"left"},l="fade";this.text=new ScalarProperty("文本",new SingleTextWidget(new AcceptAllInputFilter),j),this.isInline=new ScalarProperty("行内显示",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ISINLINE)),p),this.icon=new ScalarProperty("图标",new IconSelectWidget(IconSelectWidget.ICON_ALIGN,new AcceptAllInputFilter),m),this.theme=new ScalarProperty("主题",new ThemeSelectorWidget(new AcceptAllInputFilter),n),this.url=new ScalarProperty("链接到",new UrlOrPageSelectWidget(new AcceptAllInputFilter),o),this.extraClasses=new ScalarProperty("Extra Classes",new NullWidget,""),this.addProperty("text",this.text,{pos:0}),this.addProperty("url",this.url,{pos:1}),this.addProperty("icon",this.icon,{pos:3}),this.addProperty("theme",this.theme,{pos:4}),this.addProperty("isInline",this.isInline,{pos:5});this.addProperty("extraClasses",this.extraClasses,{pos:8})}},{defaultSize:["100%",40]}),ImageControl=Control.extend({initialize:function(){var c=this;Control.prototype.initialize.call(this,"image","image");this.margin._widget=new NullWidget(),this.image=new ScalarProperty("图片属性",new ImageWidget(new AcceptUrlInputFilter),{url:"",width:{value:100,units:"%"},height:{value:100,units:"px"},align:"left",displayMode:"block",link:window.App?"#"+window.App.getCurrentPage().getId():""}),this.addProperty("image",this.image,{pos:1})}},{defaultSize:["100%",100]}),VideoControl=Control.extend({initialize:function(){var c=this;Control.prototype.initialize.call(this,"video","video");this.margin._widget=new NullWidget(),this.video=new ScalarProperty("视频属性",new VideoWidget(new AcceptUrlInputFilter),{url:"",width:{value:100,units:"%"},height:{value:150,units:"px"},align:"left",displayMode:"block"}),this.isIE8=new ScalarProperty("isIE8",new NullWidget(),($.browser.msie&&$.browser.version<9?!0:!1)),this._random=new ScalarProperty("_random",new NullWidget(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(h){var d=Math.random()*16|0,a=h=="x"?d:(d&3|8);return a.toString(16)})),this.addProperty("video",this.video,{pos:-1}),this.addProperty("isIE8",this.isIE8,{pos:2}),this.addProperty("_random",this._random,{pos:2})},renderTo:function(j){var h=this._getRenderData(),n="#template-control-"+this._template+"-final",m=Handlebars.compile($(n).html()),l=m(h);$(j).html(l);var k=document.createElement("div");this._layout.renderTo(k),$(":first",j).append($(k).contents())}},{defaultSize:["100%",150]}),AudioControl=Control.extend({initialize:function(){var c=this;Control.prototype.initialize.call(this,"audio","audio");this.margin._widget=new NullWidget(),this.audio=new ScalarProperty("音频属性",new AudioWidget(new AcceptUrlInputFilter),{url:"",width:{value:100,units:"%"},height:{value:28,units:"px"},align:"left",displayMode:"block"}),this.isIE8=new ScalarProperty("isIE8",new NullWidget(),($.browser.msie&&$.browser.version<9?!0:!1)),this.addProperty("audio",this.audio,{pos:1}),this.addProperty("isIE8",this.isIE8,{pos:2})},renderTo:function(j){var h=this._getRenderData(),n="#template-control-"+this._template+"-final",m=Handlebars.compile($(n).html()),l=m(h);$(j).html(l);var k=document.createElement("div");this._layout.renderTo(k),$(":first",j).append($(k).contents())}},{defaultSize:["100%",28]}),FormControlTemplate=Control.extend({initialize:function(d,c){Control.prototype.initialize.call(this,d||"",c||""),this.isMini=new ScalarProperty("小巧模式",new NullWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ISMINI)),"false"),this.addProperty("isMini",this.isMini,{pos:1})},getRandomValue:function(c){return c||"val_"+this._getRandomNumber()}}),SubmitButtonControl=FormControlTemplate.extend({initialize:function(){var j=this;FormControlTemplate.prototype.initialize.call(this,"submitbutton","submitbutton");var h="提交",m="false",l="",k={icon:"",align:"left"};this.margin._widget=new NullWidget(),this.text=new ScalarProperty("文本",new SingleTextWidget(new AcceptAllInputFilter),h),this.isInline=new ScalarProperty("内联",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ISINLINE)),m),this.icon=new ScalarProperty("图标",new IconSelectWidget(IconSelectWidget.ICON_ALIGN,new AcceptAllInputFilter),k),this.theme=new ScalarProperty("主题",new ThemeSelectorWidget(new AcceptAllInputFilter),l),this.addProperty("text",this.text,{pos:0}),this.addProperty("isInline",this.isInline,{pos:5}),this.addProperty("icon",this.icon,{pos:6}),this.addProperty("theme",this.theme,{pos:7})},getDeviceExistingControl:function(c){return c('[data-cid="'+this._id+'"]').parent()}},{defaultSize:["100%",40]}),FormControl=Control.extend({initialize:function(){var h=this;Control.prototype.initialize.call(this,"form","form"),this.setIsContainer(!0),this.setSupportsSorting(!0);var d="GET",j="true";this.url=new ScalarProperty("提交到(URL)",new NullWidget(new AcceptAllInputFilter),""),this.action=new ScalarProperty("提交方式",new NullWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ACTION)),d),this.ajax=new ScalarProperty("Ajax 提交",new NullWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.AJAX)),j),this.addProperty("url",this.url,{pos:0}),this.addProperty("action",this.action,{pos:1}),this.addProperty("ajax",this.ajax,{pos:2})},onDragOver:function(y,x){var v=ControlFactory.getControlForType(x);if(!v){return}var u=v.defaultSize,t=$(this.getDeviceRenderedEl()).get(0);$(this._dropShimSelector,t).remove();var s=t.children,r=null,q=$(this._dropShim);v&&u&&q.css({width:u[0],height:u[1]});if(s.length<=0){$(t).append(q);return}for(var p=0;p<t.children.length;p++){var v=t.children[p],o=v.offsetLeft,n=v.offsetTop;if(!(p+1<t.children.length)){if(n<y.y){$(q).insertAfter(v);return}$(q).insertBefore(v);return}var m=t.children[p+1];if(y.y>n&&y.y<m.offsetTop){$(q).insertAfter(v);return}if(y.y<n){$(q).insertBefore(v);return}}!(y.x<w/2)},addChildAtPoint:function(j,h){if(this.children.length<1||!h){Control.prototype.addChildAtPoint.call(this,j,h);return}for(var m=0;m<this.children.length;m++){var l=this.children[m],k=l.getDeviceRenderedEl().get(0);if(k.offsetTop>h.y){this.insertChild(j,m);return}}Control.prototype.addChildAtPoint.call(this,j,h)}},{defaultSize:["100%",40]}),TextInputControl=Control.extend({initialize:function(){var j=this;Control.prototype.initialize.call(this,"textinput","textinput");var h="标签：",l="",k="text";this.label=new ScalarProperty("标签",new SingleTextWidget(new AcceptUrlInputFilter),h),this.addProperty("label",this.label,{pos:0}),this.placeholder=new ScalarProperty("文本占位符",new SingleTextWidget(new AcceptUrlInputFilter),l),this.addProperty("placeholder",this.placeholder,{pos:1}),this.text=new ScalarProperty("初始值",new SingleTextWidget(new AcceptUrlInputFilter),l),this.addProperty("text",this.text,{pos:2}),this.inputType=new ScalarProperty("输入框类型",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.INPUTTYPE)),k),this.addProperty("type",this.inputType,{pos:3})}},{defaultSize:["100%",56]}),TextAreaControl=Control.extend({initialize:function(){var j=this;Control.prototype.initialize.call(this,"textarea","textarea");var h="标签：",l="",k="text";this.label=new ScalarProperty("标签",new SingleTextWidget(new AcceptUrlInputFilter),h),this.addProperty("label",this.label,{pos:0}),this.placeholder=new ScalarProperty("文本占位符",new SingleTextWidget(new AcceptUrlInputFilter),l),this.addProperty("placeholder",this.placeholder,{pos:1}),this.text=new ScalarProperty("初始值",new SingleTextWidget(new AcceptUrlInputFilter),l),this.addProperty("text",this.text,{pos:2}),this.textareaHeight = new ScalarProperty("高度", new SingleTextWidget(new AcceptUrlInputFilter), l),this.addProperty("textareaHeight", this.textareaHeight, {pos: 3})}},{defaultSize:["100%",56]}),RadioButtonControl=FormControlTemplate.extend({initialize:function(){var c=this;FormControlTemplate.prototype.initialize.call(this,"radiobuttons","radiobuttons"),this._supportsChildRendering=!1,this.nameField="radio_"+this.cid,this.label=new ScalarProperty("标签",new SingleTextWidget(new AcceptUrlInputFilter),"选择："),this.orientation=new ScalarProperty("方向",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ORIENTATION)),"vertical"),this.items=new ArrayProperty("元素集合",new RadioItemsWidget(new AcceptAllInputFilter),[{text:"选项",value:this.getRandomValue()}]),this.addProperty("label",this.label,{pos:0}),this.addProperty("orientation",this.orientation,{pos:1}),this.addProperty("items",this.items,{pos:2}),this.items.bind("itemAdded",function(a){var j=new RadioInputControl,h=c.getRandomValue();j.label.setValue(a.text),j.value.setValue(h),c.addChild(j),a.value=h,a._controlId=j.getId()}),this.items.bind("itemChanged",function(a,k){var j=a._controlId,h=c.getChildWithId(j);console.log("CONTROL: changed text input with id",j);if(!h){return}h.label.setValue(a.text),h.value.setValue(a.value)}),this.items.bind("itemDeleted",function(a){var j=a._controlId,h=c.getChildWithId(j);console.log("CONTROL: changed checkbox with id",j);if(!h){return}c.removeChild(h)}),this.items.bind("itemMoved",function(a,j){var h=c.getChild(j);h&&c.moveChild(h,a)})},onAfterBind:function(){var c=new RadioInputControl;this.addChild(c),this.items.getWidget()._data.items[0]._controlId=c.getId()},cloneControl:function(r){console.log("CONTROL: clone control",this);var q=ControlFactory.newControl(this.controlType);r&&q.setId(this.getId());var p=q.getProperties();for(var o in this._propertiesMap){var n=this._propertiesMap[o].property,m=p[o];if(!m){console.error("Cloning control no property with name",o);continue}$.isArray(n.getValue())?m.property.setValue($.extend(!0,[],n.getValue())):typeof n.getValue()=="object"?m.property.setValue($.extend(!0,{},n.getValue())):m.property.setValue(n.getValue())}for(var l=0;l<this.children.length;l++){var k=this.children[l],j=k.cloneControl(r);j.setId(j.controlType+this._getRandomNumber()),j.parentControl=q,q.children.push(j),q.childrenLookup[j.getId()]=j,q.items.getWidget()._data.items[l]._controlId=j.getId()}return q},positionLayoutElement:function(h,c){var j=$(c).contents();j.insertAfter($("legend",h))},renderTo:function(j){var h=this._getRenderData(),o="#template-control-"+this._template,n=Handlebars.compile($(o).html()),m=n(h);$(j).html(m);var l=$("legend",j),k=document.createElement("div");this._layout.renderTo(k),$(k).children().insertAfter(l),this.trigger("controlRendered")}},{defaultSize:["100%",89]}),RadioInputControl=Control.extend({initialize:function(){Control.prototype.initialize.call(this,"radio","radio"),this.label=new ScalarProperty("标签",new SingleTextWidget(new AcceptUrlInputFilter),"选项"),this.value=new ScalarProperty("值",new SingleTextWidget(new AcceptUrlInputFilter),""),this.addProperty("label",this.label,{pos:0}),this.addProperty("value",this.value,{pos:1})}},{defaultSize:["100%",89]}),CheckboxControl=FormControlTemplate.extend({initialize:function(){var c=this;FormControlTemplate.prototype.initialize.call(this,"checkboxes","checkboxes"),this._supportsChildRendering=!1,this.nameField="checkbox_"+this.cid,this.label=new ScalarProperty("标签",new SingleTextWidget(new AcceptUrlInputFilter),"选择："),this.orientation=new ScalarProperty("方向",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ORIENTATION)),"vertical"),this.items=new ArrayProperty("元素集合",new RadioItemsWidget(new AcceptAllInputFilter),[{text:"选项",value:this.getRandomValue()}]),this.addProperty("label",this.label,{pos:0}),this.addProperty("orientation",this.orientation,{pos:1}),this.addProperty("items",this.items,{pos:2}),this.items.bind("itemAdded",function(a){var j=new CheckboxInputControl,h=c.getRandomValue();j.label.setValue(a.text),j.value.setValue(h),c.addChild(j),a.value=h,a._controlId=j.getId()}).bind("itemChanged",function(a,k){var j=a._controlId,h=c.getChildWithId(j);console.log("CONTROL: changed text input with id",a,k);if(!h){return}h.label.setValue(a.text),h.value.setValue(a.value)}).bind("itemDeleted",function(a){var j=a._controlId,h=c.getChildWithId(j);console.log("CONTROL: changed checkbox with id",j);if(!h){return}c.removeChild(h)}).bind("itemMoved",function(a,j){var h=c.getChild(j);h&&c.moveChild(h,a)})},onAfterBind:function(){var c=new CheckboxInputControl;this.addChild(c),this.items.getWidget()._data.items[0]._controlId=c.getId()},cloneControl:function(r){console.log("CONTROL: clone control",this);var q=ControlFactory.newControl(this.controlType);r&&q.setId(this.getId());var p=q.getProperties();for(var o in this._propertiesMap){var n=this._propertiesMap[o].property,m=p[o];if(!m){console.error("Cloning control no property with name",o);continue}$.isArray(n.getValue())?m.property.setValue($.extend(!0,[],n.getValue())):typeof n.getValue()=="object"?m.property.setValue($.extend(!0,{},n.getValue())):m.property.setValue(n.getValue())}for(var l=0;l<this.children.length;l++){var k=this.children[l],j=k.cloneControl(r);j.setId(j.controlType+this._getRandomNumber()),j.parentControl=q,q.children.push(j),q.childrenLookup[j.getId()]=j,q.items.getWidget()._data.items[l]._controlId=j.getId()}return q},positionLayoutElement:function(h,c){var j=$(c).contents();j.insertAfter($("legend",h))},renderTo:function(j){var h=this._getRenderData(),o="#template-control-"+this._template,n=Handlebars.compile($(o).html()),m=n(h);$(j).html(m);var l=$("legend",j),k=document.createElement("div");this._layout.renderTo(k),$(k).children().insertAfter(l),this.trigger("controlRendered")}},{defaultSize:["100%",89]}),CheckboxInputControl=Control.extend({initialize:function(){Control.prototype.initialize.call(this,"checkbox","checkbox"),this.label=new ScalarProperty("标签",new SingleTextWidget(new AcceptUrlInputFilter),"选项"),this.value=new ScalarProperty("值",new SingleTextWidget(new AcceptUrlInputFilter),""),this.addProperty("label",this.label,{pos:0}),this.addProperty("value",this.value,{pos:1})}},{defaultSize:["100%",89]}),SliderControl=Control.extend({initialize:function(){var j=this;Control.prototype.initialize.call(this,"slider","slider");var h="值：",l="0",k="100";this.label=new ScalarProperty("标签",new SingleTextWidget(new AcceptAllInputFilter),h),this.value=new ScalarProperty("默认值",new SingleTextWidget(new AcceptAllInputFilter),"50"),this.min=new ScalarProperty("最小值",new SingleTextWidget(new AcceptAllInputFilter),l),this.max=new ScalarProperty("最大值",new SingleTextWidget(new AcceptAllInputFilter),k),this.isHighlight=new ScalarProperty("高亮显示",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ISHIGHLIGHT)),"false"),this.theme=new ScalarProperty("主题",new ThemeSelectorWidget(new AcceptAllInputFilter),""),this.trackTheme=new ScalarProperty("滑动条背景",new ThemeSelectorWidget(new AcceptAllInputFilter),""),this.addProperty("label",this.label,{pos:0}),this.addProperty("value",this.value,{pos:1}),this.addProperty("min",this.min,{pos:1}),this.addProperty("max",this.max,{pos:2}),this.addProperty("isHighlight",this.isHighlight,{pos:3}),this.addProperty("theme",this.theme,{pos:4}),this.addProperty("trackTheme",this.trackTheme,{pos:5})}},{defaultSize:["100%",40]}),SelectControl=FormControlTemplate.extend({initialize:function(){var j=this;FormControlTemplate.prototype.initialize.call(this,"selectmenu","selectmenu"),this._supportsChildRendering=!1;var h="选择：",m="true",l="vertical",k="";this.label=new ScalarProperty("标签",new SingleTextWidget(new AcceptUrlInputFilter),h),this.isNative=new ScalarProperty("原始菜单",new SelectWidget(new AcceptAllInputFilter,$.extend(!0,[],SETTINGS.ISNATIVE)),m),this.theme=new ScalarProperty("主题",new ThemeSelectorWidget(new AcceptAllInputFilter),k),this.items=new ArrayProperty("元素集合",new RadioItemsWidget(new AcceptAllInputFilter),[{text:"选项",value:j.getRandomValue()}]),this.addProperty("label",this.label,{pos:0}),this.addProperty("isNative",this.isNative,{pos:1}),this.addProperty("theme",this.theme,{pos:2}),this.addProperty("items",this.items,{pos:3}),this.items.bind("itemAdded",function(a){a.value=j.getRandomValue()})}},{defaultSize:["100%",40]}),Handlebars.registerHelper("markerparams",function(j,h){var l=[],k;for(k=0;k<j.length;k++){l.push(j[k].location)}return l.join("|")});GoogleMapsControl=Control.extend({initialize:function(){var c=this;Control.prototype.initialize.call(this,"googlemaps","googlemaps"),this.loc=new ScalarProperty("中心位置",new SingleTextWidget(new AcceptAllInputFilter,1000),"深圳市"),this.zoom=new ScalarProperty("缩放比例",new SingleTextWidget(new AcceptAllInputFilter,500),"14"),this.width=new ScalarProperty("宽度",new SingleTextWidget(new AcceptAllInputFilter,500),"288"),this.height=new ScalarProperty("高度",new SingleTextWidget(new AcceptAllInputFilter,500),"200"),this.markers=new ArrayProperty("标记",new MapMarkerWidget(new AcceptAllInputFilter),[{location:"深圳市"}]),this.addProperty("loc",this.loc,{pos:0}),this.addProperty("zoom",this.zoom,{pos:2}),this.addProperty("width",this.width,{pos:3}),this.addProperty("height",this.height,{pos:4}),this.addProperty("markers",this.markers,{pos:5})}},{defaultSize:["100%",200]}),DataTableControl=Control.extend({initialize:function(){var c=this,d=window.App?window.App.getDataSourcesForDataTable():[],a=window.App?window.App.getDefaultColumnForDataTable():{};Control.prototype.initialize.call(this,"datatable","datatable"),this.datasource=new ScalarProperty("数据源",new SelectWidget(new AcceptAllInputFilter,d)),this.columns=new ArrayProperty("列集合",new TableColumnsWidget(new AcceptAllInputFilter)),this.addProperty("datasource",this.datasource,{pos:0}),this.addProperty("columns",this.columns,{pos:1}),this.datasource.setValue(window.App?window.App.getDefaultDataSourceForDataTable():""),this.columns.setValue(c._turnColumnsData(a)),this.datasource.unbind("propertyChanged").bind("propertyChanged",function(j,h,l,k){c.columns.setValue(c._turnColumnsData(window.App.getDefaultColumnForDataTable(l))),c.onPropertyChanged(j,h,l,!0)})},_turnColumnsData:function(c){return[{text:"列 - "+c.text||"",columnValue:c.value||"",columnText:c.text||"",priority:1}]}},{defaultSize:["100%",100]}),HtmlControl=Control.extend({initialize:function(){Control.prototype.initialize.call(this,"html","html"),this.setIsContainer(!0),this.margin._widget=new NullWidget(),this.htmlsource=new ScalarProperty("Html源码",new HtmlSourceWidget(),"在这里输入HTML源码"),this.addProperty("htmlsource",this.htmlsource,{pos:0})},},{defaultSize:["100%",20]});ControlFactory=Backbone.Model.extend({},{_controlMap:{page:PageControl,heading:HeadingControl,pageheader:PageHeaderControl,pagecontent:PageContentControl,navbar:NavBarControl,pagefooter:PageFooterControl,listview:ListViewControl,collapsible:CollapsibleSetControl,collapsiblecontent:CollapsibleContentControl,grid:GridControl,gridblock:GridBlockControl,text:TextBlockControl,link:LinkControl,button:ButtonControl,image:ImageControl,form:FormControl,submitbutton:SubmitButtonControl,textinput:TextInputControl,textarea:TextAreaControl,radiobuttons:RadioButtonControl,radio:RadioInputControl,checkboxes:CheckboxControl,checkbox:CheckboxInputControl,selectmenu:SelectControl,slider:SliderControl,video:VideoControl,audio:AudioControl,googlemaps:GoogleMapsControl,datatable:DataTableControl,html:HtmlControl},cloneControl:function(d){var c=this.newControl(d.controlType);return c},getControlForType:function(d){var c=this._controlMap[d];return c?c:null},newControl:function(h,d){var j=this._controlMap[h];return j?new j(d):(console.error("ControlFactory: unable to construct control of type: "+h),null)},deepCloneControl:function(j,h){if(h>100){return console.error("Detected circular reference in deep clone control"),null}var o=j.children,n=this.cloneControl(j);for(var m=0;m<o.length;m++){var l=o[m],k=this.deepCloneControl(l,h+1);n.addChild(k)}return n}}),ControlOutputVisitor=Backbone.Model.extend({_i:function(c){return Array(c+1).join("  ")},getAppHtml:function(j,h){var l=this.getOutputTree(j),k=$(l).html();e="#template-html",f=Handlebars.compile($(e).html().replace(/&lt;/g,"<").replace(/&gt;/g,">")),g=f({title:h,body:k});return g},getAppFragmentHtml:function(j){var h=(new Date).getTime(),m=this.getOutputTree(j),l=$(m).html(),k=(new Date).getTime();return console.log("Getting fragment HTML took",(k-h)/1000,"seconds"),l},getAppDocument:function(c){return this.getOutputDict(c)},getOutputDict:function(j){var h=j.children,n=[];for(var m=0;m<h.length;m++){var l=h[m],k=this.getOutputDict(l);n.push(k)}return{type:j.getControlType(),id:j.getId(),properties:j.getSerializedProperties(),children:n}},getOutputTree:function(c){return this.quickGetOutputTree(c)},_getOutputTree:function(r,q){if(!r._supportsChildRendering){return}var p=r.children;for(var o=0;o<p.length;o++){var n=p[o],m=n.cloneControl(),l=document.createElement("div");m.renderTo(l);var k=$(":first",l).clone();$(q).append(k);if(m.getOutputAppendSelector()==""){this._getOutputTree(m,k)}else{var j=$(m.getOutputAppendSelector(),k);this._getOutputTree(m,j)}}},quickGetOutputTree:function(d){var c=document.createElement("div");return d.quickRenderTo(c),$(c)}});UserView=Backbone.View.extend({_data:{},initialize:function(d,c){this._name=d,this._template=c},render:function(){if(!this._template){console.error("Null template for userview render");return}var d=Handlebars.compile($("#template-ui-"+this._template).html()),c=d(this._data);$(this.el).html(c)}}),HeaderView=UserView.extend({el:"#header",initialize:function(){var a=this;UserView.prototype.initialize.call(this,"headerview","headerview"),this.bindEvents(),$("#sel-device-size",this.el).filterSelector({width:120,height:204,style:"vertical-align: 6px; margin-right:6px;",multiple:false,header:false,displaySelectedText:true,change:function(){a.onChangeDeviceSize($(this).getSelectedValue())}})},events:{"click .btn-screen":"onScreenLinkClicked","click .btn-undo.on":"onUndoLinkClicked","click .btn-redo.on":"onRedoLinkClicked","click .btn-direct":"onDirectLinkClicked","click .btn-design":"onDesignLinkClicked"},bindEvents:function(){var c=this;$(".btn-pageinfo",this.el).click(function(){c.onInfoLinkClicked()}),$(".btn-publish",this.el).click(function(){c.onPublishLinkClicked()}),$(".btn-save",this.el).click(function(){$(this).hasClass("on")&&c.onSaveLinkClicked()})},onInfoLinkClicked:function(h){var d=$("#pageinfo-dialog"),c=this;if(!d.data("box")){d.box({title:"页面信息",modal:true,create:function(){c._initInfoData(),$("div.b a.btn:last",d).click(function(){d.close(),c._setInfoTips(),window.App.getLoadedApp()||c._gotoBack(c)}),$("div.b a.btn:first",d).bind("click",function(){c._saveInfo()})}})}d.open()},_initInfoData:function(){var a=this,d=window.App.getLoadedApp();if(!d){return}$("#templateName").val(d.name.getValue()),$("#templateRemark").val(d.remark.getValue())},_saveInfo:function(){if(!this._checkInfoData()){return}var j=this,h=window.App,m=h.getLoadedApp(),l=Utils.getQueryParameter("operateType"),k={id:m?m.getId():Utils.getQueryParameter("id"),name:$.trim($("#templateName").val()),remark:$.trim($("#templateRemark").val()),operateType:m?"3":l==""?"1":l,businessFlag:m?m.businessFlag.getValue():Utils.getQueryParameter("businessFlag"),businessName:m?m.businessName.getValue():Utils.getQueryParameter("businessName"),token:Utils.getQueryParameter("token"),lgnId:h.getLgnId()};Utils.request({url:m?h.getSitePath()+"editPageTemp.action":h.getSitePath()+"addPageTemp.action",data:k,type:"post",loader:false,errorTip:"#pageinfo-dialog .error-tip",success:function(a){$("#pageinfo-dialog").close();if(a.doc){h.trigger("appLoading"),h.openFromObject(a),j._savePageWhenCheckInfo(),h.trigger("appLoaded");return}j._savePageWhenCheckInfo();m&&m.initFromSerializedProperties({name:k.name,remark:k.remark,businessFlag:k.businessFlag,businessName:k.businessName})}},"#pageinfo-dialog div.b a.btn:first",j._saveInfo,this)},_savePageWhenCheckInfo:function(){var j=window.App,d=j.getSaveUrl(),a=j.getBackUrl(),k=j.getLoadedApp();var h={pageId:k.getId(),pageName:$.trim($("#templateName").val()),pageRemark:$.trim($("#templateRemark").val()),businessName:k?k.businessName.getValue():Utils.getQueryParameter("businessName"),businessFlag:k?k.businessFlag.getValue():Utils.getQueryParameter("businessFlag")};Utils.request({url:d,data:h,type:"post",loader:false,success:function(c){}})},_checkInfoData:function(){var h=this,d=!0,j=$.trim($("#templateName").val());if(j==""){h._setInfoTips("请您输入页面名称；"),d=!1}else{if(Utils.getStrLength(j)>50){h._setInfoTips("页面名称长度限制为50（汉字按2字节计算）；"),d=!1}}return d},_setInfoTips:function(c){$("#pageinfo-dialog .error-tip").html(c?Utils.getTipWapper(c):"").show()},onExportLinkClicked:function(a){return window.App.exportHtml(),!1},onPublishLinkClicked:function(h){var d=this,c=window.App;Utils.confirm("您确定要保存并且离开本页吗？",function(){c.saveApp({success:function(){Utils.request({url:c.getSitePath()+"doPublicStatus.action",data:{pageId:c.getLoadedApp().getId(),state:1},success:function(a){d._gotoBack(a)}})}})})},_gotoBack:function(c){var h=window.App,d=h.getBackUrl();d=unescape(d);if(c.resultData===undefined){d.indexOf("?")===-1?(d+="?"):(d+="&"),d+="pid=null"}else{d.indexOf("?")===-1?(d+="?"):(d+="&"),d+="pid="+c.resultData[0].id+"&name="+c.resultData[0].name,d+="&remark="+c.resultData[0].remark+"&businessName="+c.resultData[0].businessName,d+="&businessFlag="+c.resultData[0].businessFlag+"&pagurl="+c.resultData[0].url}location.href=d},onScreenLinkClicked:function(d){var c=$("a.btn-screen",this.el);$("#mainContent",parent.document).toggleClass("fullScreen_s"),$("a.btn-screen, div.h-icon-screen",this.el).toggleClass("on off"),c.attr("title")==="全屏"?c.attr("title","退出全屏"):c.attr("title","全屏")},onUndoLinkClicked:function(a){window.App.undo()},onRedoLinkClicked:function(a){window.App.redo()},onSaveLinkClicked:function(a){window.App.saveApp()},onDirectLinkClicked:function(a){$(".btn-direct, .h-icon-direct",this.el).toggleClass("trans"),window.App.toggleDeviceOrientation()},onDesignLinkClicked:function(a){var c=window.App;if(c.isPreviewMode()&&!c.canDesign()){return}$("body").toggleClass("design preview"),$(".btn-design, .h-icon-design",this.el).toggleClass("off"),c.setInterfaceMode($(".btn-design",this.el).hasClass("off")?SETTINGS.InterfaceModes.PREVIEW:SETTINGS.InterfaceModes.DESIGN)},onChangeDeviceSize:function(c){window.App.setDeviceSize(SETTINGS.DeviceSizes[c])},refreshToolbar:function(c){c?$(".btn-undo, .h-icon-undo, .btn-redo, .h-icon-redo, .btn-save, .h-icon-save",this.el).removeClass("on").toggleClass("off",true):(this._refreshUndoStyles(),this._refreshRedoStyles(),this._refreshSaveStyles())},_refreshUndoStyles:function(){var c=$(".btn-undo, .h-icon-undo",this.el);window.App._actionStack.length<=0?c.removeClass("on").toggleClass("off",true):c.removeClass("off").toggleClass("on",true)},_refreshRedoStyles:function(){var c=$(".btn-redo, .h-icon-redo",this.el);window.App._redoStack.length<=0?c.removeClass("on").toggleClass("off",true):c.removeClass("off").toggleClass("on",true)},_refreshSaveStyles:function(){$(".btn-save, .h-icon-save",this.el).removeClass("off").toggleClass("on",true)}}),PageView=UserView.extend({el:"#userview-page",initialize:function(){UserView.prototype.initialize.call(this,"pageview","pageview")},render:function(){var d=this._data.pages=window.App.getPages();for(var c in d){d[c].initTreeNodes()}UserView.prototype.render.call(this),this.trigger("rendered")},events:{"click li.item":"onControlClicked","click a.newpage":"onAddPageLinkClicked","click a.share":"onShareLinkClicked","click a.duplicate":"onDuplicateLinkClicked","click a.delete":"onDeleteLinkClicked","mouseover li.item":"onItemMouseOver","mouseout li.item":"onItemMouseOut"},onControlClicked:function(h){var d=$(h.currentTarget),j=d.data("cid");console.log("PAGE-VIEW: Control clicked:",j),h.stopPropagation(),this.trigger("controlClicked",j),this.selectControl(j)},onAddPageLinkClicked:function(h){var d=$("#newpage-dialog"),c=this;if(!d.data("box")){d.box({title:"新增页面",modal:true,btnClose:$(".btn:last",d),close:function(){var a=$("#newpage-dialog");$(".error-tip",a).html(""),$("input[name=txt_pagename]",a).val("")},create:function(){$(".btn:first",d).click(function(){var a=$(".error-tip",d),j=$.trim($("input[name=txt_pagename]",d).val());if(j===""){a.html(Utils.getTipWapper("请您输入页面名称；"));return}c.trigger("pageAdded",j,function(k){d.close();setTimeout(function(){c.trigger("controlClicked",k.getId()),c._refreshScroll()},50)})})}})}d.open()},onShareLinkClicked:function(j){var h=this,n=$(j.currentTarget),m=n.closest("li"),l=m.data("cid"),k=$("#sharepage-dialog");j.stopPropagation();if(!k.data("box")){k.box({title:"共享模板页",madal:true,btnClose:$(".btn:last",k),close:function(){var a=$("#sharepage-dialog");$(".error-tip",a).html(""),$("input",a).val("")},create:function(){$(".btn:first",k).click(function(){var a=$(".error-tip",k),c=$.trim($("input",k).val());if(c===""){a.html(Utils.getTipWapper("请您输入页面名称；"));return}h.trigger("pageShared",l,c,function(o){k.close();window.App._views.materialview.putTemplatePage(o)})})}})}$("input",k).val($("> a > span",m).text());k.open()},onDuplicateLinkClicked:function(j){var h=this,l=$(j.currentTarget),k=l.closest("li").data("cid");j.stopPropagation(),h.trigger("controlDuplicated",k,function(c){h.trigger("controlClicked",c.getId()),h.refresh(),h._refreshScroll()})},onDeleteLinkClicked:function(j){var h=this,m=$(j.currentTarget),l=m.closest("li"),k=l.data("cid");console.log("PAGE-VIEW: Deleting control",k),j.stopPropagation(),h.trigger("controlDeleted",k)},onItemMouseOver:function(c){$(".button-container",c.currentTarget).removeClass("hidden")},onItemMouseOut:function(c){$(".button-container",c.currentTarget).addClass("hidden")},onPageDeleted:function(){var c=this._data.pages[0];this.render(),this.trigger("controlClicked",c.getId()),this._selectPage(c.getId())},selectControl:function(d){var c=window.App.getControl(d);return c&&(c.getControlType()=="page"?this._selectPage(d):this._selectControl(d)),!1},_selectControl:function(d){this._currentControlId=d;var c=$('li[data-cid="'+d+'"]',this.el);return c.length>0&&this._highlightText(c),!1},_selectPage:function(d){this._currentPageId=d;var c=$('li[data-cid="'+d+'"]',this.el);$(".control",this.el).hide(),c.nextUntil(".page").removeClass("last").show().last().addClass("last"),this._highlightRow(c)},_highlightRow:function(c){this._toggleItemStyle($(".item",this.el),false),this._toggleItemStyle(c,true)},_toggleItemStyle:function(d,c){$(d).toggleClass("selected",c),$("> a > .b-icon",d).toggleClass("selected",c)},_highlightText:function(c){this._toggleItemStyle($(".item.control",this.el),false),this._toggleItemStyle(c,true)},_refreshScroll:function(){var a=$(".b-c",this.el).get(0);a.scrollTop=a.scrollHeight},refresh:function(){console.log("PAGE-VIEW: refresh");this.render(),this._selectPage(this._currentPageId),this._selectControl(this._currentControlId)}});ControlView=UserView.extend({el:"#userview-control",_data:{categories:[{name:SETTINGS.WIDGETTABS.toolsBar,id:"navigation",controls:[new PageHeaderControl,new PageFooterControl,new NavBarControl]},{name:SETTINGS.WIDGETTABS.button,id:"action",controls:[new ButtonControl,new LinkControl]},{name:SETTINGS.WIDGETTABS.content,id:"content",controls:[new HeadingControl,new ListViewControl,new TextBlockControl,new ImageControl,new HtmlControl]},{name:SETTINGS.WIDGETTABS.form,id:"forms",controls:[new TextInputControl,new TextAreaControl,new SelectControl,new RadioButtonControl,new CheckboxControl,new SubmitButtonControl]}]},initialize:function(){UserView.prototype.initialize.call(this,"controlview","controlview")},events:{"click .widget-tabs .button":"onTabClick"},render:function(){UserView.prototype.render.call(this),this.bindEvents()},onTabClick:function(d){var c=$(d.currentTarget).data("category");c=="ALL"?$(".icon-list li",this.el).show():($(".icon-list li",this.el).hide(),$('.icon-list li[data-category="'+c+'"]',this.el).show()),$(".widget-tabs .button",this.el).removeClass("active"),$(d.currentTarget).addClass("active")},bindEvents:function(){var c=window.App,h=$("#phone-drop");$(".icon-list > li",this.el).draggable({appendTo:"body",opacity:0.5,cursorAt:{left:2,top:2},helper:function(){var j=$(":first",this).clone(),d=$('<div class="b-icon b-icon-add"></div>');return d.css({position:"absolute",top:"4px",left:"4px"}),$(j).append(d),j},start:function(){if(!c.canDesign()){return !1}c.isPreviewMode()&&$(".btn-design").click(),$("#phone-drop").removeClass("empty").show(),$(this).data("origPosition",$(this).position())},stop:function(){$("#phone-drop").addClass("empty").hide()},revert:"invalid"}),h.droppable({greedy:!0,tolerance:"pointer",activate:function(a,d){c.onDropActivate(a.originalEvent,d)},deactivate:function(a,d){c.onDropDeactivate(a.originalEvent,d)},over:function(a,d){c.onDropOver(a.originalEvent,d)},out:function(a,d){c.onDropOut(a.originalEvent,d)},drop:function(a,d){c.onDrop(a.originalEvent,d)}}),h.mousemove(function(a){if(c.isPreviewMode()){return}c._detachedControlEl&&c._detachedControlEl.css({left:a.pageX+"px",top:a.pageY+"px"}),c.onDropTargetMouseMove(a)})}});MaterialView=UserView.extend({el:"#userview-material",_data:{tpls:[],pages:[]},initialize:function(){UserView.prototype.initialize.call(this,"materialview","materialview");this._initTemplate()},events:{"click div.widget-tabs a.button":"onTabsClicked","click li.item":"onItemClicked","click li.item a.insert":"onInsertTemplateClicked","click a.delete_tpl":"onDeleteTemplete","mouseover li.item":"onItemMouseOver","mouseout li.item":"onItemMouseOut"},render:function(){UserView.prototype.render.call(this)},onTabsClicked:function(d){var c=$(d.currentTarget);if(c.hasClass("active")){return}$("li > a",this.el).toggleClass("active"),$("ul.item-list",this.el).toggleClass("hidden")},onItemClicked:function(k){var j=$(k.currentTarget),h=j.data("cid"),m=j.index(),l=j.hasClass("tpl")?this._data.tpls[m].code:this._stringifyTemplatePage(m);this._highlightRow(j),this._preview(l),this.trigger("previewed")},onInsertTemplateClicked:function(k){var j=$(k.currentTarget),h=j.closest("li.item"),m=h.index(),l=h.hasClass("tpl")?this._data.tpls[m].code:this._stringifyTemplatePage(m);k.stopPropagation(),window.App.insertTemplate(l,j.attr("insert-default")==="true")},_stringifyTemplatePage:function(d){var c=this._data.pages;return"["+(c.length>0?JSON.stringify(c[d].pbpgtemp_jsoncode):"")+"]"},onItemMouseOver:function(j){var h=window.App,m=$(j.currentTarget),l=m.closest("li"),k=l.attr("data-lgnId");if(h.getLgnId()!==k){l.find(".delete_tpl").remove()}$(".button-container",j.currentTarget).removeClass("hidden")},onItemMouseOut:function(c){$(".button-container",c.currentTarget).addClass("hidden")},onDeleteTemplete:function(j){var h=window.App,m=$(j.currentTarget).closest("li"),l=this._data.pages,k=m.attr("data-pubid");j.stopPropagation();Utils.confirm("确定要删除该模板吗？",function(){Utils.request({url:h.getSitePath()+"delPugPgTempPage.action",data:{pubId:k},success:function(d){if(d.result===true){m.hasClass("selected")&&($("#userview-page .page:first").trigger("click")),m.remove();for(var c=0,a=l.length;c<a;c++){if(l[c].pbpgtemp_id==k){l.splice(c,1);break}}}else{Utils.alert("抱谦，删除失败，请稍候重试。")}}})})},_preview:function(c){var d=window.App;d.previewTemplate(c),d.isPreviewMode()||$("#header a.btn-design").trigger("click")},_highlightRow:function(c){this._toggleRowStyle($("li.item",this.el),false),this._toggleRowStyle(c,true)},_toggleRowStyle:function(d,c){$(d).toggleClass("selected",c),$("> a > .b-icon",d).toggleClass("selected",c)},_initTemplate:function(){this._loadTemplates(),this._loadTemplatePages(!1)},_loadTemplates:function(){var c=this;Utils.request({url:window.App.getSitePath()+"queryUserdefinedControl.action",loader:false,async:false,success:function(a){c._data.tpls=$.parseJSON(a.controlString)}})},_loadTemplatePages:function(h,d){var j=this;Utils.request({url:window.App.getSitePath()+"queryPublicPageTemplateList.action?token="+Utils.getQueryParameter("token"),loader:false,async:h===undefined?true:h===true,success:function(a){j._data.pages=a;$.isFunction(d)&&d.call(this)}})},putTemplatePage:function(c){this._data.pages.splice(0,0,c),this.render()}});PropertyView=UserView.extend({el:"#userview-property-content",initialize:function(c){UserView.prototype.initialize.call(this,"propertyview","propertyview")},render:function(){var a=$(this.el);$("#userview-property").hasClass("mCustomScrollbar")||$("#userview-property").mCustomScrollbar({autoHideScrollbar:true,scrollInertia:500,theme:"dark",advanced:{updateOnContentResize:true}});if(this._control){var m=[],l=this._control.getPropertiesSorted(),j,h;for(var k=0;k<l.length;k++){j=l[k],j.property.renderWidget(),h=$(j.property.getRenderedWidget()),a.append(h)}console.log("PROPERTY-VIEW: rendered "+l.length+" properties")}},setControl:function(c){this._control=c},getControl:function(){return this._control},showRenderedProperties:function(c){this._renderedProperties=c,this.render(),$("input:first",this.el).focus()},onAttach:function(){if(this._control){var h=this._control.getPropertiesSorted();for(var d=0;d<h.length;d++){var j=h[d];j.property.getWidget().onAttach()}}},clear:function(){this._renderedProperties="",this._control=null,$(this.el).empty()},refresh:function(){console.log("PROPERTY-VIEW: refresh");this.render(),this.onAttach()}});Utils={getStrLength:function(d){var c=0;if($.trim(d)){c=$.trim(d).replace(/[^\x00-\xff]/g,"##").length}return c},getQueryParameter:function(h){var j=location.href,d="";j=j.replace("?","?&").split("&");console.log("after:"+j);for(i=1;i<j.length;i++){if(j[i].indexOf(h+"=")==0){d=j[i].replace(h+"=","")}}return d},_alert:function(n,d,j,o,c){var l='<div id="$id" class="alert"><div class="content">';if(n==="error"){l+='<div class="icon1"></div><div class="icon2" style="background:none;font-size:38px;margin:2px 0 10px 15px;color:#ccc;">ERROR</div><div class="txt"></div>'}else{l+='<div class="icon"></div><div class="txt"></div>'}l+='</div><div class="bottom"><div class="right buttons"><a class="btn btn-blue" href="javascript:void(0);"><div class="l"></div><div class="l-c">确定</div><div class="r"></div></a>';if(n==="confirm"){l+='<a class="btn btn-blue" href="javascript:void(0);"><div class="l"></div><div class="l-c">取消</div><div class="r"></div></a>'}l+="</div></div></div>";var k="#alert_panel",m=null,a="提示",h="alert-box";if(n==="error"){k="#error_panel",a="错误提示",h="error-box"}else{if(n==="confirm"){k="#confirm_panel",h="confirm-box"}}if(j){if(typeof j==="function"){var p=o;o=j;if(p&&typeof p==="object"){c=p}}else{if(typeof j==="string"){h+=" "+j}}}m=$(k),m.length<1&&($(l.replace(/\$id/,k.substring(1))).appendTo("body"),m=$(k)),m.data("box")||m.box({title:a,modal:true,boxClass:h}),m.find(".txt").html(d);if(n==="confirm"){m.find(".btn:last").unbind("click").click(function(){m.close()}),m.find(".btn:first").unbind("click").click(function(){m.close(),$.isFunction(o)&&o.call(c||this,!0)})}else{m.find(".btn").unbind("click").click(function(){m.close(),$.isFunction(o)&&o.call(c||this,!0)})}m.open()},error:function(c,d,a){Utils._alert("error",c,d,a)},alert:function(c,d,a){Utils._alert("alert",c,d,a)},confirm:function(c,d,a){Utils._alert("confirm",c,d,a)},getTipWapper:function(c){var a='<div class="tip-wapper"><span class="tip-title">提示：</span><span class="tip-txt">$msg</span></div>';return a.replace(/\$msg/,c||"")},routes:{},request:function(d,p,o,h){if(!d||!d.url){return}var n="_"+encodeURIComponent(d.url).replace(/[\/\.%!?&=]/g,""),l=Utils.routes[n]||{};if(d.url===l.url&&l.request){return}Utils.routes[n]={url:d.url,request:true};var j="#loader",m="#loader-back",c='<div id="loader" class="loader"><h1>请稍候，正在发送请求...</h1></div><div id="loader-back" class="loader-back"></div>',k=d.loader===undefined?true:d.loader===true,a=(typeof d.errorTip==="string"||typeof d.errorTip==="object")?d.errorTip:false;if(a&&!$.isFunction(a.html)){a=$(a)}$.ajax({url:d.url,cache:d.cache===undefined?false:d.cache===true,type:d.type||"get",data:d.data||{},dataType:d.dataType||"json",timeout:d.timeout||60000,async:d.async===undefined?true:d.async===true,beforeSend:function(q){$.isFunction(d.beforeSend)&&d.beforeSend.call(this,q),q.setRequestHeader("X-XMLHttpRequest","AJAX"),a&&a.html("").hide(),p&&$.isFunction(o)&&$(p).attr({click:"",disabled:"disabled"}).unbind("click").addClass("disabled"),k===true&&($(j).length<1&&$(c).appendTo("body"),$(j).css({top:$(window).height()/2+"px"}).show(),$(m).show())},success:function(q){if(q.code==="0"){$.isFunction(d.success)&&d.success.call(this,q.data)}else{if(q.code==="-1"){Utils.error("抱歉，服务器崩溃了，请稍候重试；")}else{a?a.html(Utils.getTipWapper(q.msg)).show():Utils.error(q.msg)}}},error:function(q,s,r){Utils.error("抱歉，请求失败，请稍候重试；"),$.isFunction(d.error)&&d.error.call(this,q,s,r)},complete:function(){delete Utils.routes[n],setTimeout(function(){if(p&&$.isFunction(o)){$(p).removeClass("disabled").removeAttr("disabled").bind("click",function(){return o.call(h||window),!1})}if(k===true){$(j).hide(),$(m).hide()}},300);$.isFunction(d.complete)&&d.complete.call(this)}})},IdGiver:{_types:{},forceIncrement:function(c){this._types.hasOwnProperty(c)||(this._types[c]=0),++this._types[c]},give:function(d){this._types.hasOwnProperty(d)||(this._types[d]=0);var c=++this._types[d];for(;;){if(!window.App.getControl(d+c)){return c}c=++this._types[d]}},giveRandom:function(c){return this.forceIncrement(),c+parseInt(Math.random()*1000000+1,10)}},UUID:function(){"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(h){var d=Math.random()*16|0,a=h=="x"?d:(d&3|8);return a.toString(16)})},ValidUrl:function(c){var a=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i");if(!a.test(c)){return false}else{return true}},containsPoint:function(j,h){if(!j||!h||h.length<=0){return}var n=h.offset(),m=h.outerWidth(),l=h.outerHeight(),k=this._getCalculatedMargin(h);if(k[3]<0&&k[1]<0){if(j.pageX>n.left+m+-k[1]||j.pageX<n.left+k[3]||j.pageY>n.top+l||j.pageY<n.top){return !1}}else{if(j.pageX>n.left+m||j.pageX<n.left||j.pageY>n.top+l||j.pageY<n.top){return !1}}return !0},_getCalculatedMargin:function(r){if(r){var q=parseInt(r.css("marginLeft"),10),p=parseInt(r.css("paddingLeft"),10),o=parseInt(r.css("marginTop"),10),n=parseInt(r.css("paddingTop"),10),m=parseInt(r.css("marginRight"),10),l=parseInt(r.css("paddingRight"),10),k=parseInt(r.css("marginBottom"),10),j=parseInt(r.css("paddingBottom"),10);return[o+n,m+l,k+j,q+p]}return[0,0,0,0]}},BuilderDeviceGlue={_builder:null,_device:null,_deviceSelector:"#phone iframe",initFromDevice:function(c){this._device=c},getDeviceWindow:function(){return this._deviceWindow?this._deviceWindow:(this._deviceWindow=$(this._deviceSelector).get(0).contentWindow,this._deviceWindow)},getDeviceFromBuilder:function(){return this._device},getBuilderFromDevice:function(){return this._builder?this._builder:(this._builder=window.App,this._builder)}},Builder=Backbone.View.extend({_document:{root:null,lookup:{},resouces:{}},_views:{},_currentOrientation:SETTINGS.DeviceOrientation.PORTRAIT,_currentInterfaceMode:SETTINGS.InterfaceModes.DESIGN,_currentDeviceSize:SETTINGS.DeviceSizes._320x480,_currentPage:null,_actionStack:[],_redoStack:[],_internalActionCount:0,_lastSavedAction:0,_device:null,_isUiInited:!1,_isLoading:!1,_dragDropType:null,_sitePath:null,_interimStack:[],_canDesign:!0,_backUrl:null,_saveUrl:null,_LgnId:null,initialize:function(){console.log("BUILDER: initializing")},render:function(){this._renderHeaderView(),this._renderPageView(),this._renderControlView(),this._renderMaterialView(),this._renderPropertyView(),this._initAccordion(),this._isUiInited=!0,this._backUrl=unescape(Utils.getQueryParameter("backurl")),this._saveUrl=unescape(Utils.getQueryParameter("saveurl")),this._LgnId=Utils.getQueryParameter("lgnId")},canDesign:function(){return this._canDesign},getDocument:function(){return this._document},getLoadedApp:function(){return this._document.root},isUiInited:function(){return this._isUiInited},isLoading:function(){return this._isLoading},setInterfaceMode:function(c){this._currentInterfaceMode=c,this.trigger("interfaceModeChanged")},getInterfaceMode:function(){return this._currentInterfaceMode},isPreviewMode:function(){return this._currentInterfaceMode===SETTINGS.InterfaceModes.PREVIEW},setCurrentPage:function(d){var c=this._document.lookup[d];this._device._setCurrentPage(d),this._currentPage=c},getCurrentPage:function(){return this._currentPage},setSelectedControl:function(c){this._selectedControl=c},getSelectedControl:function(){return this._selectedControl},getControl:function(c){return this._document.lookup[c]},indexControl:function(c){this._document.lookup[c.getId()]=c},unindexControl:function(c){delete this._document.lookup[c.getId()]},getPageView:function(){return this._views.pageview},getPropertyView:function(){return this._views.propertyview},getPages:function(){return this._document.root?this._document.root.getChildren():[]},_renderHeaderView:function(){this._views.headerview=new HeaderView},_renderPageView:function(){var d=this,c;c=new PageView(),c.render(),c.bind("controlClicked",d.onControlClicked,this),c.bind("pageAdded",d.onPageAdded,this),c.bind("controlDeleted",d.onControlDeleted,this),c.bind("controlDuplicated",d.onControlDuplicated,this),c.bind("pageShared",d.onPageShared,this),c.bind("rendered",d.onPageViewRendered,this),this._views.pageview=c},_renderControlView:function(){var c=new ControlView();c.render(),this._views.controlview=c},_renderMaterialView:function(){var c=new MaterialView();c.render(),c.bind("previewed",this.onTemplatePreviewed,this),this._views.materialview=c},_renderPropertyView:function(){var c=new PropertyView();c.render(),this._views.propertyview=c},_initAccordion:function(){a();$("#b-l-c").delegate("div.b-h","click",function(c){a($(this).parent())});$(window).bind("resize",function(){a()});function a(l){var j=$("#b-l-c"),h=$("> div.userview",j),n=$(l||h[0]),m=n.index(),k=j.height();h.each(function(c,o){var d=$(o);if(c<=m){d.css({top:32*c})}else{d.css({top:k-32*(h.length-c)})}d.toggleClass("expand",c==m).find("div.b-h > span").toggleClass("selected",c===m)})}},onPageViewRendered:function(){var h=$("#userview-page"),d=this._interimStack,k={};$(".page:first .delete",h).remove();for(var j=0;j<d.length;j++){k[d[j]]=true}this._canDesign=!k.hasOwnProperty(this._currentPage.getId())},onMaterialViewRendered:function(){},initEvents:function(){var c=this;this.bind("appLoading",function(a){console.log("BUILDER: app loading"),c._isLoading=!0}),this.bind("appLoaded",function(a){console.log("BUILDER: app loaded"),c._device.initAppPages(c._document.root),setTimeout(function(){c.hiddenDropTip(),c.onControlClicked(a||c._document.root.children[0].getId()),c._isLoading=!1},10)}),this.bind("interfaceModeChanged",function(a){c._updateInterfaceMode()})},bindShortcuts:function(){var c=this;key("ctrl+z",function(){c.undo()}),key("ctrl+y",function(){c.redo()}),key("+z",function(){c.undo()}),key("+y",function(){c.redo()})},bindDeviceEvents:function(){var c=this;this._device.bind("controlSelected",function(a){var d=c._document.lookup[a];if(!d){console.error("Clicked control but unable to find it in document!");return}c.onControlSelected(d)}),this._device.bind("controlMoved",function(a,l,k,j){if(k===j){return}var h=c.getControl(a);if(!h){console.error("Tried to move control that doesn't exist!");return}c.moveControl(h,l,k,j)}),this._device.bind("pageChanged",function(a){c.isLoading()||(c.getPageView()._selectPage(a),c.setCurrentPage(a),c._device.refreshPage())})},onControlDeselected:function(c){if(!this.isUiInited()){return}this.onAllControlsDeselected()},onAllControlsDeselected:function(){if(!this.isUiInited()){return}this.hidePropertyDialog(),this.getPropertyView().clear(),this._device.onAllControlsDeselected()},isSelectableControl:function(d){var c=d.getControlType();return !{app:1,gridblock:1,pagecontent:1,collapsiblecontent:1,checkbox:1,radio:1,splitprimary:1,splitsecondary:1}.hasOwnProperty(c)},onControlSelected:function(d){if(!this.isUiInited()||!this.isSelectableControl(d)||this.isPreviewMode()){return}var c=this.getPropertyView();this.onAllControlsDeselected(),this.setSelectedControl(d),this.getPageView().selectControl(d.getId()),c.setControl(d),c.render(),this.showPropertyDialogForControl(d),this._device.onControlSelected(d)},onControlClicked:function(j){var h=this._document.lookup[j],m=this._interimStack,l={};for(var k=0;k<m.length;k++){l[m[k]]=true}h.getControlType()=="page"&&(this._device.showPage(j),this._currentPage=h,this._canDesign=!l.hasOwnProperty(h.getId())),this.emptyInterimStack(),this._canDesign&&(this.deselectPreviewTemplate(),this.isPreviewMode()&&$("a.btn-design",this._views.headerview.el).trigger("click")),this.onControlSelected(h)},onPageAdded:function(h,d){var j=this.addPage(h);$.isFunction(d)&&d(j)},onControlDeleted:function(h,d){var j=this.getControl(h);if(!j){return}this.removeControl(j,d)},onControlDuplicated:function(j,h){var l=this.getControl(j);if(l){var k=this.duplicateControl(l);$.isFunction(h)&&h(k)}},onPageShared:function(j,h,l){var k=this.getControl(j);if(k){this.savePage(k,h,l)}},onDeviceReady:function(){console.log("BUILDER: on device ready"),window.scrollTo(0,0),this._device=BuilderDeviceGlue.getDeviceFromBuilder(),this.bindDeviceEvents(),this.bindShortcuts(),this.render(),this.initEvents(),this._deviceInited=!0,this.trigger("appInited")},_updateInterfaceMode:function(){switch(this._currentInterfaceMode){case SETTINGS.InterfaceModes.DESIGN:this._changeToDesignMode();break;case SETTINGS.InterfaceModes.PREVIEW:this._changeToPreviewMode();break}},_changeToDesignMode:function(){this.bindDeviceEvents(),this._device.designModeHint(),this._currentPage&&this.onControlClicked(this._currentPage.getId()),this._isInspectorShowing=!1,this._views.headerview.refreshToolbar()},_changeToPreviewMode:function(){this.onAllControlsDeselected(),this._device.previewModeHint(),this._isInspectorShowing=!1,this._views.headerview.refreshToolbar(!0)},onDropActivate:function(d,c){console.log("BUILDER: drop activate")},onDropDeactivate:function(){console.log("BUILDER: drop deactivate"),this.onDropFinished();this._selectedContainer=null},onDropOver:function(h,d){console.log("BUILDER: drop over");var j=$(d.draggable).data("cid");this._dragDropType=j,this._device.startDragDrop(j)},onDropOut:function(d,c){console.log("BUILDER: drop out"),this._dragDropType=null,this._device.stopDragDrop(),this.onDropFinished();this._selectedContainer&&this._selectedContainer.onDragOut(),this._selectedContainer=null},onDrop:function(C,B){if(!this._selectedContainer){return}var A=$("#phone .content"),z=A.offset(),y=C.pageX-z.left,x=C.pageY-z.top,v=BuilderDeviceGlue.getDeviceWindow(),u=v.pageYOffset,t={x:y,y:Math.max(x+u,0)};var s=$(B.draggable).data("cid");console.log("BUILDER: dropped %s over container %s",s,this._selectedContainer.getId()),B.helper.remove();var r,q,l=!1,c=!1;r=ControlFactory.newControl(s);this.onDropFinished(),this.addControl(r,this._selectedContainer,t,!0),this._selectedContainer=null,this._device.scrollToControl(r),r.controlType!=="page"&&r.controlType!=="pagecontent"?this.onControlSelected(r):this.onAllControlsDeselected()},onDropTargetMouseMove:function(v){if(!this._currentPage){return}var u=$("#phone .content"),t=u.offset(),s=v.pageX-t.left,r=v.pageY-t.top,q=$("#phone-drop").offset(),p=$("#phone-drop").height(),o=p-60,n=BuilderDeviceGlue.getDeviceWindow(),m=n.document.documentElement.scrollTop||n.pageYOffset||n.document.body.scrollTop;r>o?this._device.scrollDown():r<60?this._device.scrollUp():this._device.stopScrolling(),this._currentPage.getDeviceRenderedEl().is(":visible")||(console.error("Current page was hidden. Showing it"),this._device.showPage(this._currentPage.getId()));var l=this._getContainerUnderMouse({x:s,y:Math.max(r+m,0)});l&&(l!=this._selectedContainer&&this._selectedContainer&&this._selectedContainer.onDragOut(),l.onDragOver({x:s,y:Math.max(r+m,0)},this._dragDropType),this._selectedContainer=l,this._device.repositionCurrentSelector())},onDropFinished:function(){var c=BuilderDeviceGlue.getDeviceWindow();c.$(".cfwx-control.selected").removeClass("selected"),this._selectedContainer&&this._selectedContainer.onDropFinished()},_getContainerUnderMouse:function(d){var c=this._controlContainsIterative(this._currentPage,d);return c},_controlContainsIterative:function(j,h){var o=[],n,m;o.push(j);while(o.length){n=o.shift();for(var l=0;l<n.children.length;l++){var k=n.children[l];k.isContainer()&&k.containsPoint(h)&&(m=k,o.splice(0,0,k))}}return m},documentChanged:function(){},_bindAddControlEvents:function(d){var c=this;if(d.hasAlreadyAfterBound()){return}d.bind("controlUpdated",function(h,k,j){if(c.isLoading()){return}c._device.updateControl(h),c.documentChanged(),k&&c.getPropertyView().refresh(),c.getPageView().refresh()}),d.bind("propertyChanged",function(j,h,a){c.pushAction({action:SETTINGS.ActionTypes.PROPERTY_FORWARD,reaction:SETTINGS.ActionTypes.PROPERTY_BACK,control:d,property:j,oldValue:h,newValue:a})}),d.bind("controlRendered",function(){console.log("BUILDER: control rendered",this.getId());c._device.onControlRendered(this),this.getControlType()=="page"&&c.getPageView().refresh()}),d.bind("childAdded",function(h){console.log("BUILDER: child added",h.getId(),h),c._document.lookup[h.getId()]=h,c._bindAddControlEvents(h)}),d.bind("childRemoved",function(h){h.getControlType()!="page"&&c.getPageView().refresh(),delete c._document.lookup[h.getId()]})},_calculateOffsetContentMovePosition:function(j,h){for(var l=0;l<j.children.length;l++){var k=j.children[l];if(k.getAppendMode()===SETTINGS.ControlAppendMode.PAGE_PREPEND){h++}else{break}}return h},_moveControl:function(j,h,m,l){var k=this._calculateOffsetContentMovePosition(h,l);h.moveChild(j,k),console.log("Moved child",j,"of parent",h,"to position",l),this._device.updateControl(h),this.documentChanged()},moveControl:function(j,h,l,k){var h=j.getParent();this.pushAction({action:SETTINGS.ActionTypes.MOVE_FORWARD,reaction:SETTINGS.ActionTypes.MOVE_BACK,control:j,parent:h,oldPosition:l,newPosition:k}),this._moveControl(j,h,l,k)},_cleanupChildrenFromRemovedControl:function(j){var h=[],m;h.push(j);while(h.length){m=h.shift(),delete this._document.lookup[m.getId()];for(var l=0;l<m.children.length;l++){var k=m.children[l];h.splice(0,0,k)}}},_removeControl:function(h){var m=this.getPages();var k=this._document.lookup[h.getId()];if(!k){console.error("Unable to find control",h.getId()," in document lookup map!"),this.onAllControlsDeselected();return}delete this._document.lookup[h.getId()],h.getParent()?h.getParent().removeChild(h):console.error("Null parent control on child removal!");if(h.getControlType()==="page"){if(m.length>0){var l=m[0];this.onAllControlsDeselected(),this.setCurrentPage(l.getId())}else{console.error("Tried to switch to page on page delete but none exist!")}var j=this;setTimeout(function(){j._device.removeControl(h),j.onControlDeselected(h),j.documentChanged(),j.getPageView().onPageDeleted()},150)}else{this._device.removeControl(h),this.onControlDeselected(h),this.documentChanged()}},removeControl:function(c){this.pushAction({action:SETTINGS.ActionTypes.REMOVE,reaction:SETTINGS.ActionTypes.ADD,control:c,parent:c.getParent()}),this._removeControl(c,b)},removeSelectedControl:function(){var c=this.getSelectedControl();c&&this.removeControl(c)},_changeProperty:function(j,h,l){var k=this._views;console.log("BUILDER: changing property",j.getId(),h.getName(),l),h.setValue(l,!0),this._device.updateControl(j),k.pageview.refresh(),k.propertyview.refresh()},duplicateControl:function(j){var h=j.getParent(),l=j.cloneControl(!1),k=$.trim(l.title.getValue())||j.getId();return l.title.setValue(k+" 副本"),this._bindAddControlEvents(l),l.setAlreadyAfterBound(!0),this.addControl(l,h),l.getControlType()=="page"&&(this._currentPage=l),this.indexControl(l),this._duplicateIndexControls(l),l},getDuplicatedControl:function(d){var c=d.cloneControl(!0);return this._bindAddControlEvents(c),c.setAlreadyAfterBound(!0),this.indexControl(c),this._duplicateIndexControls(c),c},_duplicateIndexControls:function(h){for(var d=0;d<h.children.length;d++){var j=h.children[d];this.indexControl(j),this._bindAddControlEvents(j),j.setAlreadyAfterBound(!0),this._duplicateIndexControls(j)}},_userAddedControl:function(c){this._device.scrollToControl(c),c.controlType!=="page"&&c.controlType!=="pagecontent"?this.onControlSelected(c):this.onAllControlsDeselected()},_addControlToContainer:function(j,h,m,l,k){console.log("BUILDER: adding control to container",j,h,m,l,k);if(!h){return}!l||l&&h.acceptControl(j)?(this._device.addControlToContainer(j,h,m),this._document.lookup[j.getId()]=j):this._addControlToContainer(j,h.getParent(),m,l,k+1)},_addControl:function(j,h,l,k){console.log("BUILDER: adding control",j,h,l,k);if(h){this._bindAddControlEvents(j),j.hasAlreadyAfterBound()||(j.onAfterBind(),j.setAlreadyAfterBound(!0)),this._addControlToContainer(j,h,l,k,1)}else{this._bindAddControlEvents(j),j.hasAlreadyAfterBound()||(j.onAfterBind(),j.setAlreadyAfterBound(!0)),this._device.addControl(j),j.controlType!=="page"&&j.controlType!="pagecontent"?this.onControlSelected(j):this.onAllControlsDeselected()}},_addControlFromObject:function(j,h,l,k){console.log("BUILDER: adding control",j,h,l,k);if(h){this._bindAddControlEvents(j),j.hasAlreadyAfterBound()||j.setAlreadyAfterBound(!0),this._addControlToContainer(j,h,l,k,1)}else{this._bindAddControlEvents(j),j.hasAlreadyAfterBound()||j.setAlreadyAfterBound(!0),this._device.addControl(j)}},addControl:function(j,h,l,k){this.pushAction({action:SETTINGS.ActionTypes.ADD,reaction:SETTINGS.ActionTypes.REMOVE,control:j,parent:h?(h.acceptControl(j)?h:h.getParent()):h,point:l}),this._addControl(j,h,l,k)},addPage:function(h){var d=new PageControl;d.title.setValue(h),this.addControl(d,this._document.root),this._currentPage=d;var j=new PageContentControl;return this.addControl(j,d),this.onAllControlsDeselected(),this.getPageView().refresh(),d},addPageControl:function(c){return this._currentPage||(this._currentPage=c),this._addControl(c,this._document.root),this.onAllControlsDeselected(),this.getPageView().refresh(),c},_isValidJSON:function(h){if($.trim(h)==""){return !1}var d=null;try{d=JSON.parse(h)}catch(j){return console.error("Invalid data, unable to parse",h),!1}return d?!0:!1},_newAppFromObject:function(h,c){var j=new AppControl;return j.initFromSerialized(c),j},_newPageFromObject:function(h,c){var j=new PageControl;return j.initFromSerialized(h),typeof c==="number"?this._document.root.insertChild(j,c):this._document.root.addChild(j),this._document.lookup[j.getId()]=j,this.addControl(j),this._currentPage=j,j},openFromObject:function(h){console.log("BUILDER: new app");var c=this,m=h.doc;if(!m){Utils.alert("Unable to load app.");return}this._document.root=this._newAppFromObject(m.id,m);if(m.children.length===0){var j=this.addPage("首页");Utils.IdGiver.forceIncrement("page"),this._openFromObjectRoot(j,null,this._document.root)}else{for(var l=0;l<m.children.length;l++){var k=m.children[l],j=this._newPageFromObject(k);Utils.IdGiver.forceIncrement("page"),this._openFromObjectRoot(j,k,this._document.root)}}},_openFromObjectRoot:function(j,h,p,o){j.getControlType()!="page"&&this._addControlFromObject(j,p);if(!h||!h.children){return}var l=Utils.IdGiver;for(var k=0;k<h.children.length;k++){var n=h.children[k],m=ControlFactory.newControl(n.type,n.type=="heading"&&h.type!="pagecontent"?!0:!1);if(!m){continue}if(o){n.id=l.giveRandom(n.type);if(n.type=="collapsiblecontent"){h.properties.sections[k]._controlId=n.id}else{if(n.type=="radio"||n.type=="checkbox"){h.properties.items[k]._controlId=n.id}}}else{l.forceIncrement(n.type)}m.initFromSerialized(n,o),console.log("BUILDER: \tAdding child %s from %s",m.getId(),j.getId()),this._openFromObjectRoot(m,n,j,o)}},deselectPreviewTemplate:function(){var c=this._views.materialview;$("li.item",c.el).removeClass("selected")},onTemplatePreviewed:function(){console.log("BUILDER: onTemplatePreviewed");var h=this._views.pageview,d=this._interimStack,k={};for(var j=0;j<d.length;j++){k[d[j]]=true}$("li.item",h.el).each(function(a,l){var c=$(l);c.hasClass("page")?(c.removeClass("selected"),$("> a > div.b-icon",c).removeClass("selected"),k.hasOwnProperty(c.data("cid"))&&c.hide()):c.hide()})},emptyInterimStack:function(){console.log("BUILDER: emptyInterimStack");var d=this._interimStack,c;for(var h=0;h<d.length;h++){c=this.getControl(d[h]);delete this._document.lookup[d[h]],c&&c.getParent()&&c.getParent().removeChild(c)}this._interimStack=[]},previewTemplate:function(c){this._insertTemplate(c,!0)},insertTemplate:function(d,c){this._insertTemplate(d,!1,c),$("#userview-page div.b-h div.l-c").trigger("click")},_insertTemplate:function(r,q,p){console.log("BUILDER: insert template");if(!r){Utils.alert("Unable insert to template.");return}var s=$("#loader"),h=$("#loader-back"),j=Utils.IdGiver,k=r,l=$.parseJSON(r);s.css({top:$(window).height()/2+"px"}).show(),h.show(),this.trigger("appLoading");for(var m=0;m<l.length;m++){var o=l[m],n=j.giveRandom(o.type);k=k.replace(new RegExp(o.id,"g"),n)}l=$.parseJSON(k);for(var m=0;m<l.length;m++){var o=l[m],n=this._newPageFromObject(o,p===true?m:null);q&&this._interimStack.push(o.id),this._openFromObjectRoot(n,o,this._document.root,true)}this.trigger("appLoaded",l[0].id),setTimeout(function(){s.hide(),h.hide()},500)},hidePropertyDialog:function(){this._propertyDialog&&$(this._propertyDialog).dialog("close")},updatePropertyView:function(c){this.showPropertyDialogForControl(c)},showPropertyDialogForControl:function(h){var c=this,l=h.getControlType(),k=316,j="";switch(l){case"image":j="m-dialog image-dialog";k=530;break;case"video":j="m-dialog video-dialog";k=530;break;case"audio":j="m-dialog audio-dialog";k=530;break;case"html":j="m-dialog html-dialog";k=530;break;case"text":k=372;j="editor-dialog";break;default:break}if(!this._propertyDialog){this._propertyDialog=$("#property-dialog").dialog({autoOpen:!1,resizable:!1,minHeight:40,maxHeight:500,create:function(a,d){var n=$(this).closest(".ui-dialog"),m=$(".ui-dialog-titlebar",n);$(".ui-dialog-titlebar-close",m).html('<span class="bui-icon-dialogclose"></span>')},open:function(a,d){c._views.propertyview.onAttach()}})}$(this._propertyDialog).dialog("option","title",h.getName().toUpperCase()),$(this._propertyDialog).dialog("option",{title:h.getName().toUpperCase(),width:k,position:[$(window).width()-k-40,70],dialogClass:j}),$(this._propertyDialog).dialog("open")},pushAction:function(d){var c=this._views.headerview;this.isLoading()||(this._redoStack=[],this._actionStack.push($.extend(d,{page:this._currentPage.getId()})),c.refreshToolbar(),this._internalActionCount++)},scriptAction:function(h,c){if(!c.action){console.error("Null action to script");return}var j=c.control.getControlType();j!="page"&&c.page!=this._currentPage.getId()&&this.onControlClicked(c.page);switch(h){case SETTINGS.ActionTypes.ADD:console.log("BUILDER: add action",c.parent.getId(),c.parent),j=="page"?this.addPageControl(c.control):c.parent?this._addControl(c.control,c.parent,c.point):this._addControl(c.control);break;case SETTINGS.ActionTypes.REMOVE:this._removeControl(c.control);break;case SETTINGS.ActionTypes.MOVE_BACK:this._moveControl(c.control,c.parent,c.newPosition,c.oldPosition);break;case SETTINGS.ActionTypes.MOVE_FORWARD:this._moveControl(c.control,c.parent,c.oldPosition,c.newPosition);break;case SETTINGS.ActionTypes.PROPERTY_BACK:this._changeProperty(c.control,c.property,c.oldValue);break;case SETTINGS.ActionTypes.PROPERTY_FORWARD:this._changeProperty(c.control,c.property,c.newValue);break;default:console.error("No script for action",c.action)}},undo:function(){if(this.isPreviewMode()){return}var c=this._actionStack.pop();c&&(console.log("BUILDER: UNDO ACTION"),this.scriptAction(c.reaction,c),this._redoStack.push(c)),this._views.headerview.refreshToolbar()},redo:function(){if(this.isPreviewMode()){return}var c=this._redoStack.pop();c&&(console.log("BUILDER: REDO ACTION"),this.scriptAction(c.action,c),this._actionStack.push(c)),this._views.headerview.refreshToolbar()},setDeviceSize:function(c){this._currentOrientation==SETTINGS.DeviceOrientation.LANDSCAPE?this._setDeviceSize([c[1],c[0]]):this._setDeviceSize(c),this._currentDeviceSize=c},_setDeviceSize:function(c){$("#phone .device .t, #phone .device .m, #phone .device .b").css({width:c[0]+86+"px"}),$("#phone .device .t .l-c").css({width:c[0]-114+"px"}),$("#phone .device .m .l, #phone .device .m .r").css({height:c[1]-96+"px"}),$("#phone .device .m .l-c, #phone .device .sized").css({width:c[0]+"px",height:c[1]+"px"}),$("#phone .device .b .l-c").css({width:c[0]-114+"px"}),this._device&&this._device.repositionCurrentSelector()},toggleDeviceOrientation:function(){if(this._currentOrientation==SETTINGS.DeviceOrientation.LANDSCAPE){this.setDeviceOrientation(SETTINGS.DeviceOrientation.PORTRAIT),this._setDeviceSize(this._currentDeviceSize)}else{this.setDeviceOrientation(SETTINGS.DeviceOrientation.LANDSCAPE),this._setDeviceSize([this._currentDeviceSize[1],this._currentDeviceSize[0]])}},setDeviceOrientation:function(c){this._currentOrientation=c},getDocumentAsHtml:function(){var d=new ControlOutputVisitor,c=d.getAppHtml(this._document.root,this._document.root.pageName.getValue());return c},savePage:function(k,j,q){var p=this,o=new ControlOutputVisitor,n=o.getOutputDict(k),m=k.getId(),l;n.properties.title=j;l=JSON.stringify(n).replace(new RegExp(k.getId(),"g"),Utils.IdGiver.giveRandom("page"));Utils.request({url:p.getSitePath()+"addPublicPageTemplate.action",type:"post",async:false,data:{"basePageTemplate.token":Utils.getQueryParameter("token"),"basePageTemplate.pbpgtemp_name":j,"basePageTemplate.pbpgtemp_jsoncode":l,"basePageTemplate.lgnId":window.App.getLgnId(),"basePageTemplate.pbpgtemp_sourcecode":""},success:function(c){var a=c.pubTemp;console.log(a);console.log("BUILDER: save page success"),$.isFunction(q)&&q.call(this,a)}})},saveApp:function(j){var h=this,d=new ControlOutputVisitor,l=this._document.root,k=document.getElementById("pageViewer");$("#loader").show();$("#loader-back").show();k.contentWindow._renderPages(d.getAppFragmentHtml(l),function(a){var c=j||{};if($(a).find("input[type=submit]").length>0){a=$("<div/>").append($('<form action=""/>').append(a)).html()}Utils.request({url:h.getSitePath()+"saveBasePageTemp.action",type:"post",loader:false,data:{doc:JSON.stringify(d.getAppDocument(l)),html:a,lgnId:window.App.getLgnId()},loader:c.loader===undefined?true:c.loader===true,success:function(m){console.log("BUILDER: save success"),$.isFunction(c.success)&&c.success();$("#loader").hide();$("#loader-back").hide()}})})},_getAppFragmentHtml:function(){var d=$("<div/>"),c=BuilderDeviceGlue.getDeviceWindow().jQuery,a=c("input[type=submit]").length==0?c("body").html():($('<form action=""/>').append(c("body").html()));return d.append(a),d.find("div[data-role=page]:first, div.ui-loader").remove(),d.find("div.highlight-selector, div.highlight").remove(),d.html()},loadApp:function(){var c=this;c.trigger("appLoading"),Utils.request({url:c.getSitePath()+"toEditPageTemp.action",data:{pageId:Utils.getQueryParameter("id")},success:function(a){c.openFromObject(a),c.trigger("appLoaded")}})},exportHtml:function(){var c=this;Utils.request({url:c.getSitePath()+"compressHtml.action",type:"post",data:{html:c.getDocumentAsHtml()},success:function(h){if(h.result=="success"){var a=window.onbeforeunload;window.onbeforeunload=undefined,window.location=c.getSitePath()+"downloadHtml.action",setTimeout(function(){window.onbeforeunload=a},5000)}}})},getImageResouces:function(){var a=this,j=this._document,h="image";Utils.request({url:a.getSitePath()+"queryImageInfoList.action?token="+Utils.getQueryParameter("token"),async:false,success:function(c){console.log("BUILDER: loaded image resouces"),j.resouces[h]=c.imgList}});return $.extend([],j.resouces[h])},putImageResouce:function(d){var j=this._document,h="image";$.isArray(j.resouces[h])&&j.resouces[h].push(d)},getVideoResouces:function(j){var h=this,m=this._document,l=h.getLoadedApp().productId.getValue(),k=(j=="1"?"video_pro_"+l:"video_pub");if(!m.resouces[k]){Utils.request({url:h.getSitePath()+"queryVideoInfoList.action",data:{videoType:j,productId:j=="1"?l:""},async:false,success:function(a){console.log("BUILDER: loaded video resouces",j,l),m.resouces[k]=a.videoList}})}return $.extend([],m.resouces[k])},putVideoResouce:function(j,h){var m=this._document,l=this.getLoadedApp().productId.getValue(),k=(j=="1"?"video_pro_"+l:"video_pub");$.isArray(m.resouces[k])&&m.resouces[k].push($.extend({},h))},getAudioResouces:function(j){var h=this,m=this._document,l=h.getLoadedApp().productId.getValue(),k=(j=="1"?"audio_pro_"+l:"audio_pub");if(!m.resouces[k]){Utils.request({url:h.getSitePath()+"queryAudioInfoList.action",data:{audioType:j,productId:j=="1"?l:""},async:false,success:function(a){console.log("BUILDER: loaded video resouces",j,l),m.resouces[k]=a.audioList}})}return $.extend([],m.resouces[k])},putAudioResouce:function(j,h){var m=this._document,l=this.getLoadedApp().productId.getValue(),k=(j=="1"?"audio_pro_"+l:"audio_pub");$.isArray(m.resouces[k])&&m.resouces[k].push($.extend({},h))},getAppVariables:function(){var d=this,c=this._document;if(!c.resouces.variables){Utils.request({url:d.getSitePath()+"queryGlobalBariable.action",async:false,success:function(a){console.log("BUILDER: loaded global variable",a),c.resouces.variables=d._buildTreeNodes(a)}})}return $.extend([],c.resouces.variables)},_buildTreeNodes:function(h){var d=[],j=this;if(h&&$.isArray(h.globalBariableList)){$.each(h.globalBariableList,function(a,c){c.classifyname=="-1"&&d.push(j._turnNodeData(h.globalBariableList,c))})}return d},_getChildNodes:function(j,h){var l=[],k=this;if(h.classify=="1"){$.each(j,function(a,c){c.classifyname==h.variableid&&l.push(k._turnNodeData(j,c))})}return l},_turnNodeData:function(d,c){return{id:""+c.variableid,text:c.variablename,value:c.variablevalue,hasChildren:c.classify=="1",isexpand:!0,complete:!0,ChildNodes:this._getChildNodes(d,c)}},getSitePath:function(){if(!this._sitePath){var d=window.document.location.pathname,c=d.substring(0,d.substr(1).indexOf("/")+2);this._sitePath=(c=="/pagebuilder/"?"/":c)}return this._sitePath},hiddenDropTip:function(){$("#phone-drop").hide()},showDropTip:function(){$("#phone-drop").show()},getDataSourcesForDataTable:function(){var d=this,c=this._document;if(!c.resouces.tablesources){Utils.request({url:d.getSitePath()+"queryDataSourceViewList.action",async:false,success:function(k){var j=[],h;for(var a=0;a<k.dataSourceViewList.length;a++){h=k.dataSourceViewList[a];j.push({text:h.dataSourceNameCZ,value:h.dataSourceNameEN})}c.resouces.tablesources=j}})}return $.extend([],c.resouces.tablesources)},getDefaultDataSourceForDataTable:function(){var c=this.getDataSourcesForDataTable();return c&&c.length>0?c[0].value:null},getColumnsForDataTable:function(j){var h=this,d=this._document,k=j||this.getDefaultDataSourceForDataTable();if(!d.resouces.tablecolumns){d.resouces.tablecolumns={}}if(k&&!d.resouces.tablecolumns[k]){Utils.request({url:h.getSitePath()+"queryDataSourceColumnList.action",data:{dataSourceViewNo:k},async:false,success:function(m){var l=[],c;for(var a=0;a<m.dataSourceViewColumnList.length;a++){c=m.dataSourceViewColumnList[a];l.push({text:c.columnName,value:c.dbCoulumnName})}d.resouces.tablecolumns[k]=l}})}return $.extend([],d.resouces.tablecolumns[k])},getDefaultColumnForDataTable:function(d){var c=this.getColumnsForDataTable(d);return c&&c.length>0?c[0]:{text:"",value:""}},getBackUrl:function(){return this._backUrl},getSaveUrl:function(){return this._saveUrl},getLgnId:function(){return this._LgnId}});